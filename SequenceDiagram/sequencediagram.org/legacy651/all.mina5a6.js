//Copyright SequenceDiagram.org
var SEQ=SEQ||{};SEQ.main=function(){function a(a){ka=a}function b(){return document.getElementById("diagramCanvas")}function c(){return ka?ka:b().getContext("2d")}function d(){return document.getElementById("interactionCanvas")}function e(){return d().getContext("2d")}function f(){return document.getElementById("participantCanvas")}function g(){return f().getContext("2d")}function h(a){var b=U.getScrollInfo();U.setValue(a),U.scrollTo(b.left,b.top)}function i(a,b){if(ia.length>0)var c=ia[ia.length-1];a!=c&&(b||(ja=[]),ia.push(a)),ia.length>=200&&ia.shift()}function j(a){if(ja.length>0)var b=ja[ja.length-1];a!=b&&ja.push(a),ja.length>=200&&ja.shift()}function k(){if(ia.length>=2){var a=ia.pop();j(a);var b=ia.pop();h(b),SEQ.parser.parse(!0)}}function l(){if(ja.length>0){var a=ja.pop();h(a),SEQ.parser.parse(!0)}}function m(a){var b=SEQ.parser.diagram.fontFamily;return a+"pt "+b}function n(a){ga.INCREASE===a?ba<72&&(ba++,SEQ.parser.parse()):ga.DECREASE===a&&ba>4&&(ba--,SEQ.parser.parse())}function o(){document.getElementById("cover").style.display="none";var a=document.getElementById("imageSavePopup");a&&(a.style.display="none");var b=document.getElementById("infoPopup");b&&(b.style.display="none");var c=document.getElementById("shareUrlPopup");c&&(c.style.display="none");var d=document.getElementById("instructionsPopup");d&&(d.style.display="none")}function p(){var a,c=b(),d=q().imgtype,e=q().imgquality;a=d&&e?c.toDataURL(d,parseFloat(e.replace("#",""))):c.toDataURL();var f=document.getElementById("imageDiv"),g=document.getElementById("diagramImage");g&&f.removeChild(g);var h=800/c.width,i=600/c.height,j=h<i?h:i,k=document.createElement("img");k.src=a,k.style.width=j*c.width+"px",k.style.height=j*c.height+"px",k.id="diagramImage",f.appendChild(k),document.getElementById("cover").style.display="block",document.getElementById("imageSavePopup").style.display="block"}function q(){var a={};return window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(b,c,d){a[c]=d}),a}function r(){var a=document.getElementById("linkWithName");SEQ.parser.diagram.title&&(a.innerHTML=SEQ.parser.diagram.title.title);var b=L(),c=LZString.compressToEncodedURIComponent(b),d=window.location.href;d.indexOf("index.html")>-1&&(d=d.substring(0,d.indexOf("index.html"))),d.indexOf("#")>-1&&(d=d.substring(0,d.indexOf("#"))),"/"!==d.substring(d.length-1,d.length)&&(d+="/");var e=d+"index.html#initialData="+c;a.href=e,document.getElementById("cover").style.display="block",document.getElementById("shareUrlPopup").style.display="block";var f=document.getElementById("shareRawUrl");f.value=e,f.setSelectionRange(0,f.value.length),f.focus()}function s(){var a=q().initialData,c=q().format;if(!a&&window.location.hash){var d=window.location.hash.substring(1);d.indexOf("initialData=")>-1&&(a=d.replace("initialData=",""))}if(a)if(0===a.indexOf("http://")||0===a.indexOf("https://")||0===a.indexOf("file://")){var e=new XMLHttpRequest;e.open("GET",a,!0),e.onreadystatechange=function(){if(4==this.readyState&&200==this.status&&(SEQ.main.updateSource(this.responseText),SEQ.parser.parse(),"png"===c)){var a=b();window.location.href=a.toDataURL("image/png")}},e.send()}else{var f=LZString.decompressFromEncodedURIComponent(a);SEQ.main.updateSource(f)}else{var g="C4S2BsFMAIBUAsQGdrOgQ2qCkBQuBBcEAY0gFoA+AIQHsAjALgGFiSBrDAOwBNoeATugDmWWtBIDI6YDExSAjgFdISYNFoCAOl2ABPAA4wwqLlngwktJQLIYpmYOOAXoUAGbBCbSAB5y5HRMgiJi0AC2tABueFy0shoxAtBBADQAItb0UBJsnE7QkDwmsgAewCx55jAAVDUA-HWoJLRm7prQdSBcagJKJKCtSE3ovJ01kKXo4QZQwzVAA",h=LZString.decompressFromEncodedURIComponent(g);SEQ.main.updateSource(h)}}function t(){return m(ba)}function u(){return ba+"pt sans-serif"}function v(){return m(ba*ca)}function w(){return m(ba*da)}function x(){return m(ba*ea)}function y(){return ba*fa}function z(){return y()+"pt FontAwesome"}function A(){return y()+"pt Material Design Icons"}function B(){return ba}function C(){if(!SEQ.interactor.editEntryTextAreaActive()){T&&clearTimeout(T);for(var a=[],b=L().split("\n"),c=0;c<b.length;c++){var d=b[c];d.indexOf(SEQ.entityParticipant.Type.FONT_AWESOME)>-1?a.indexOf("10pt FontAwesome")==-1&&a.push("10pt FontAwesome"):d.indexOf(SEQ.entityParticipant.Type.MATERIAL_DESIGN_ICONS)>-1&&a.indexOf("10pt Material Design Icons")==-1&&a.push("10pt Material Design Icons")}if(ha.forEach(function(b){var c=a.indexOf(b);c>-1&&a.splice(c,1)}),a.length>0){var e=[];a.forEach(function(a){e.push(document.fonts.load(a))}),Promise.all(e).then(function(){a.forEach(function(a){ha.push(a)}),T=setTimeout(SEQ.main.parse,50)})}else T=setTimeout(SEQ.parser.parse,50)}}function D(){return document.getElementById("syntaxErrors")}function E(a){var b=D();a.length>0?(b.style.background="rgba(240, 200, 200, 0.9)",b.style.cursor="pointer",b.style.textDecoration="underline"):(b.style.background="rgba(255, 255, 255, 0.9)",b.style.cursor="default",b.style.textDecoration="none"),aa||U.clearGutter("errors");var c="",d=0;a.forEach(function(b){aa||U.setGutterMarker(b.lineNumber-1,"errors",F()),d++;var e="line "+b.lineNumber+": "+b.line;c+=d<a.length?e+"\n":e}),b.value=c}function F(){var a=document.createElement("div");return a.style.color="red",a.innerHTML="âŠ ",a}function G(){var a=document.getElementById("top");a.style.display="none";var b=document.getElementById("actions");b.style.top="5px";var c=D();c.style.top="5px";var d=document.getElementById("source");d.style.top="55px";var e=document.getElementById("handleWrapper");e.style.top="55px";var f=document.getElementById("diagramCanvas");f.style.top="5px";var g=document.getElementById("interactionCanvasWrapper");g.style.top="5px",SEQ.interactor.onWindowScroll()}function H(){var a=f(),b=document.getElementById("partcipantOverlayCheckbox");b.checked?a.style.display="block":a.style.display="none"}function I(a){var b=document.createElement("textarea");b.style.position="fixed",b.style.top=0,b.style.left=0,b.style.width="2em",b.style.height="2em",b.style.padding=0,b.style.border="none",b.style.outline="none",b.style.boxShadow="none",b.style.background="transparent",b.value=a,document.body.appendChild(b),b.select(),document.execCommand("copy"),document.body.removeChild(b)}function J(a){var b=U.getValue()+a;h(b),C()}function K(a){var b=a+U.getValue();h(b),C()}function L(){return U.getValue()}function M(){return U.getInputField().blur()}function N(){return U.getInputField().focus()}function O(a,b,c){U.setSelection({line:a,ch:b},{line:a,ch:c})}function P(a){var b=a.clientX-W,c=a.clientY-X;V.style.width=Y+b+"px",V.style.top=Z+c+"px",U.setSize($+b+"px",_+c+"px"),a.preventDefault()}function Q(a){W=a.clientX,X=a.clientY,Y=parseInt(V.style.width,10),Z=parseInt(V.style.top,10);var b=document.getElementsByClassName("CodeMirror")[0];$=parseInt(b.style.width,10),_=parseInt(b.style.height,10),document.addEventListener("mousemove",P),document.addEventListener("mouseup",R),a.preventDefault()}function R(a){document.removeEventListener("mousemove",P),document.removeEventListener("mouseup",R),a.preventDefault()}function S(){CodeMirror.commands.autocomplete=function(a){a.showHint({hint:CodeMirror.hint.seqdiahint,completeSingle:!1})},U=aa?CodeMirror(document.getElementById("source"),{value:"# Loading...",styleActiveLine:{nonEmpty:!0},lineNumbers:!0,lineWrapping:!0,extraKeys:{"Ctrl-Space":"autocomplete"},undoDepth:0}):CodeMirror(document.getElementById("source"),{value:"# Loading...",styleActiveLine:{nonEmpty:!0},lineNumbers:!0,lineWrapping:!0,extraKeys:{"Ctrl-Space":"autocomplete"},gutters:["CodeMirror-linenumbers","errors"],undoDepth:0}),U.on("keyup",function(a,b){b.keyCode>=37&&b.keyCode<=40||C()}),U.on("inputRead",function(a,b){"cut"!=b.origin&&"paste"!=b.origin&&CodeMirror.commands.autocomplete(a)});var a=350,b=512;U.setSize(a+"px",b+"px"),V=document.getElementById("handle"),V.style.width=a+"px",V.style.top=b+"px",V.addEventListener("mousedown",Q)}var T,U,V,W,X,Y,Z,$,_,aa=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,ba=11,ca=.8,da=1.2,ea=1.5,fa=4,ga={INCREASE:"+",DECREASE:"-"},ha=[],ia=[],ja=[],ka=null;return{init:function(){SEQ.seqDiaHint.init(),SEQ.seqDiaMode.init(),S(),SEQ.interactor.init(),SEQ.contextMenu.init(),window.addEventListener("message",function(a){if("connect"===a.data.action){var c=a.data.extensionId;console.log("sequencediagramorg connecting to "+c);var d=chrome.runtime.connect(c);d.onMessage.addListener(function(a){console.log("sequencediagramorg received ",a);var c={action:a.action};"EXPORT_SOURCE"===a.action?c.result=L():"EXPORT_PNG"===a.action?c.result=b().toDataURL("image/png"):"EXPORT_SVG"===a.action?c.result=SEQ.saveAndOpen.paintSvgCanvas():c.result="unknown action",d.postMessage(c)})}},!1)},parse:C,getDiagramContext:c,getDiagramCanvas:b,getSourceValue:L,selectInSource:O,blurEditor:M,focusEditor:N,getInteractionCanvas:d,getInteractionContext:e,getParticipantCanvas:f,getParticipantContext:g,FontChange:ga,changeFontSize:n,exportDiagram:p,closeDiagramImagePopup:o,minimizeTop:G,getFontSize:B,getFontSansSerifNormal:u,getFontNormal:t,getFontSmall:v,getFontBig:w,getFontTitle:x,getFontFontAwesome:z,getFontMaterialDesignIcons:A,getFontIconSize:y,fontSizeTitleRatio:ea,createShareUrl:r,loadInitialData:s,updateSyntaxErrors:E,updateSource:h,pushUndoChange:i,undoChange:k,redoChange:l,copyTextToClipboard:I,appendToSource:J,prependToSource:K,toggleParticipantOverlay:H,setCanvasToSvgContext:a,getSyntaxErrorsTextarea:D}}();var SEQ=SEQ||{};SEQ.metrics=function(){function a(a){return b(a,"Pp",SEQ.main.getFontSize())}function b(a,b,c){function d(){for(var a=0;a<g;a++)for(var b=0;b<h;b++){var c=4*(a*h+b);if(0!=j[c])return a}return 0}function e(){for(var a=g-1;a>0;a--)for(var b=0;b<h;b++){var c=4*(a*h+b);if(0!=j[c])return a}return g}var f=document.createElement("canvas"),g=2*c,h=2*c;f.height=g,f.width=h;var i=f.getContext("2d");i.fillRect(0,0,h,g),i.textBaseline="top",i.fillStyle="white",i.font=a,i.fillText(b,0,0);var j=i.getImageData(0,0,h,g).data;return e()-d()}function c(a,b){var c,d=SEQ.main.getDiagramContext();return b?(d.save(),d.font=b,c=d.measureText(a),d.restore()):c=d.measureText(a),c.width}function d(){var b=SEQ.main.getFontNormal(),c=1.2565541*a(b),d=SEQ.main.getInteractionContext();d.font=b;var g=SEQ.main.getDiagramContext();g.font=b,e.textLineHeight=c,e.textSmallLineHeight=.85*c,e.textBigLineHeight=1.25*c;var h=SEQ.main.getFontSansSerifNormal(),i=1.2565541*a(h);e.baseSpaceMetric=i,e.textTopBottomPadding=.3*i,e.textPosYOffset=.1*i,e.fragmentTextPosYOffset=.4*i,e.entityMarginTop=i*f.spacingRation*SEQ.parser.diagram.entrySpacingRatio,e.textPadding=i/2,e.boxBleed=.9*i,e.entryMarginSide=i/2,e.diagramMarginTop=i/2,e.diagramMarginBottom=3.5*i,e.diagramLifeLineDashSize=i/1.3,e.diagramLifeLineSpaceSize=i/3,e.diagramLifeLineWeight=i/12,e.diagramLineWeight=i/12,e.participantMarginTop=i/2,e.participantMarginSide=i/2,e.participantMarginBottom=i/2,e.participantPadding=i,e.participantTopBottomPadding=.7*i,e.participantImageHeight=4.5*i,e.participantTypeLineWeight=.17*i,e.participantBoxLineWeight=.16*i,e.participantDestroySize=1.8*i,e.participantDestroyLineWeight=.16*i,e.messageSelfRefHeight=i,e.messageSelfRefWidth=4*i,e.messageSelfRefSideMargin=i/2,e.messageArrowWidth=i/1.2,e.messageLineDashWidth=i/2.5,e.messageInteractionMargin=.15*i,e.messageCreatorInteractionMargin=.1*i,e.messageCreatorPosDiffThreshold=.2*i,e.dragAndDropInteractionMargin=3*i,e.dividerBleed=2*i,e.dividerLineSpacing=i/3,e.fragmentLineWeight=i/7,e.fragmentBleed=3.5*i,e.fragmentMarginSide=i,e.fragmentElseLineDashWidth=i/4,e.fragmentLabelEdgeLength=.6*i,e.fragmentLabelSmallHeight=.6*i,e.fragmentLabelSidePadding=i,e.fragmentHeight=1.2*i,e.fragmentTextSideMargin=i,e.collisionBleed=i/3,e.fragmentCollisionLineCompensation=i/2,e.entryMoverXCollisionWidth=i,e.entryMoverThreshold=i/3,e.activationSideWidth=i/2,e.activationAfterHeight=1.2*i}var e={},f={entrySpacingRatio:1,spacingRation:1.5};return{setupAllMetrics:d,calcWidth:c,calcHeight:b,data:e,constants:f}}();var SEQ=SEQ||{};SEQ.parser=function(){function a(a){function c(a){for(var j=a;j<t.length;j++){var k,l=t[j];if(k=SEQ.entityTitle.parse(l))g.title=k,i(k);else if(k=SEQ.entityFontFamily.parse(l))g.fontFamily=k.fontFamily,SEQ.metrics.setupAllMetrics(),i(k);else if(k=SEQ.entityEntrySpacing.parse(l))g.entrySpacingRatio=k.entrySpacing,SEQ.metrics.setupAllMetrics(),i(k);else if(k=SEQ.entityParticipantSpacing.parse(l))g.participantSpacing=k.participantSpacing,i(k);else if(k=SEQ.entityFontSize.parse(l))i(k);else if(k=SEQ.entityMessage.parse(l,p,m,n,o,u,g.participantMaxHeight+SEQ.metrics.data.participantMarginTop))i(k),m&&n++;else if(k=SEQ.entityAutoNumber.parse(l))m=k.enabled,m&&(isNaN(k.value)||(n=k.value)),i(k);else if(k=SEQ.entityLinear.parse(l))o=k.enabled,i(k);else if(k=SEQ.entityParallel.parse(l))p=k.enabled,i(k);else if(k=SEQ.entityNoteBoxLeftRight.parse(l,p))i(k);else if(k=SEQ.entityNoteBoxOver.parse(l,p))i(k);else if(k=SEQ.entityParticipant.parse(l,j,c)){if(i(k),k.loadingImage)return}else(k=SEQ.entityDivider.parse(l))?i(k):(k=SEQ.entityFragment.parse(l,u,g.participantMaxHeight+SEQ.metrics.data.participantMarginTop))?i(k):(k=SEQ.entityActivation.parse(l))?i(k):(k=SEQ.entitySpace.parse(l))?i(k):(k=SEQ.entityCreateDestroy.parse(l,u,g.participantMaxHeight+SEQ.metrics.data.participantMarginTop))?i(k):(k=SEQ.entityActiveColor.parse(l))?i(k):(k=SEQ.entityLifeLineColor.parse(l))?i(k):(k=SEQ.entityLifeLineWeight.parse(l))?i(k):(i({raw:l}),e.exec(l)||f.exec(l)||g.errors.push({lineNumber:j+1,line:l}))}g.participants.length>0?(SEQ.entityFragment.updateParticipantWidths(),b()):g.title||(g.title=SEQ.entityTitle.parse("title Empty diagram, click the ? icon for instructions and examples")),g.entries.forEach(function(a){a.collisionTypeAreas&&!a.enclosingCollapsedFragment&&g.collisionTypeAreas.load(a.collisionTypeAreas())}),g.participants.forEach(function(a){g.collisionTypeAreas.load(a.collisionTypeAreas())}),SEQ.main.updateSyntaxErrors(g.errors);for(var q in h)if(h.hasOwnProperty(q)){var r=h[q];r.inUse||delete h[q]}SEQ.painter.paint(),d.ongoing=!1}function i(a){var b=g.participantMaxHeight+SEQ.metrics.data.participantMarginTop;if(a.type&&a.type!=SEQ.entityParticipant.Type.PARTICIPANT){if(j(a),a.enclosingCollapsedFragment)return void g.entries.push(a);var c=l();if(k(c,a),a.parallel&&c&&c.parallel)a.posY=u+b;else if(a.linear&&null!=a.linearRequiredHeight&&c&&c.linear){a.posY=u+a.linearRequiredHeight+b,u=a.posY-b;for(var d,e=a.fromParticipantName===a.toParticipantName?a.posY-SEQ.metrics.data.messageSelfRefHeight:a.posY,f=g.entries.length-1;f>=0;f--){var h=g.entries[f];if(h.type){if(!h.linear||d&&d.type&&null==d.linearRequiredHeight)break;h.posY=e,d=h}}}else a.posY=u+a.topMargin+a.totalHeight+b,u=a.posY-b,c&&c.participantToCreate&&a.type===SEQ.entityActivation.Type.ACTIVATE&&(a.posY-=c.participantToCreate.height/2)}else a.posY=u+b;g.entries.push(a)}function j(a){SEQ.entityFragment.populateEnclosingCollapsedFragment(a),a.updateParticipantWidths&&!a.enclosingCollapsedFragment&&a.updateParticipantWidths(a),a.updateActivationPosDiff&&a.updateActivationPosDiff(a),a.updateEnclosingFragments&&a.updateEnclosingFragments(a)}function k(a,b){a&&a.message&&b.activation&&(b.fromParticipantName==a.fromParticipantName||b.fromParticipantName==a.toParticipantName)&&(a.updateActivationPosDiff&&a.updateActivationPosDiff(a,b),a.updateEnclosingFragments&&a.updateEnclosingFragments(a),a.updateParticipantWidths&&a.updateParticipantWidths(a))}function l(){for(var a=g.entries.length-1;a>=0;a--){var b=g.entries[a];if(b.type&&!b.activation)return b}}SEQ.interactor.cancelAllInteraction(),g.entrySpacingRatio=SEQ.metrics.constants.entrySpacingRatio,g.fontFamily="sans-serif",SEQ.metrics.setupAllMetrics(),d.ongoing=!0,g.entries=[],g.errors=[],g.participantsByName={},g.participants=[],g.ongoingFragments=[],g.fragments=[],g.ongoingActivations={},g.title=null,g.createdParticipantNames={},g.participantSpacing=0,g.participantMaxHeight=SEQ.metrics.data.textLineHeight+SEQ.metrics.data.textTopBottomPadding+2*SEQ.metrics.data.participantTopBottomPadding+SEQ.metrics.data.participantTypeLineWeight,g.participantActiveColor=null,g.participantLifeLineColor=null,g.participantLifeLineWeight=null,g.collisionTypeAreas=rbush();var m=!1,n=1,o=!1,p=!1;for(var q in h)if(h.hasOwnProperty(q)){var r=h[q];r.inUse=!1}var s=SEQ.main.getSourceValue();SEQ.main.pushUndoChange(s,a);var t=s.split("\n");t.forEach(function(a){var b=SEQ.entityCreateDestroy.createdParticipant(a);b?g.createdParticipantNames[b]=!0:(b=SEQ.entityMessage.createdParticipant(a),b&&(g.createdParticipantNames[b]=!0))});var u=SEQ.metrics.data.diagramMarginTop;c(0)}function b(){function a(a){var b=a>0?c[a-1]:null,d=c[a],e=(b?b.width/2+SEQ.metrics.data.participantMarginSide:0)+d.width/2+SEQ.metrics.data.participantMarginSide,f=b&&b.entityRightWidth>d.entityLeftWidth?b.entityRightWidth:d.entityLeftWidth;b&&(f+=b.timelineRightWidth),f+=d.timelineLeftWidth;var g=Math.max(e,f);return{participantsWidth:e,largestSideWidth:g}}var b=0,c=g.participants;if(g.participantSpacing==SEQ.entityParticipantSpacing.equal){for(var d=0,e=0;e<c.length;e++){var f=a(e);f.largestSideWidth>d&&(d=f.largestSideWidth)}for(var h=0;h<c.length;h++)h>0?(b+=d,c[h].posX=b):(b+=a(h).largestSideWidth,c[h].posX=b)}else for(var i=0;i<c.length;i++){var j=i>0?c[i-1]:null,k=c[i],l=a(i),m=l.largestSideWidth,n=l.participantsWidth-SEQ.metrics.data.participantMarginSide,o=m-n;j&&g.participantSpacing*SEQ.metrics.constants.spacingRation>o/SEQ.metrics.data.baseSpaceMetric&&(m=g.participantSpacing*SEQ.metrics.data.baseSpaceMetric*SEQ.metrics.constants.spacingRation+n),b+=m,k.posX=b}}function c(a){return a in SEQ.parser.diagram.participantsByName}var d={ongoing:!1},e=new RegExp("^\\s*$"),f=new RegExp("^\\s*((:?#|//).*)$"),g={},h={};return{parse:a,diagram:g,participantExists:c,parsingState:d,imageCache:h,regExpComment:f}}();var SEQ=SEQ||{};SEQ.entityParticipant=function(){function a(a,b,d){var e=r.exec(a);if(null!=e&&e.length>s.ALIAS){var f=e[s.TYPE];f||(f=e[s.ICON_FONT_TYPE]);var g=e[s.ALIAS],h=e[s.LONG_NAME],i=e[s.COLOR_NAME],j=e[s.COLOR_HEX],k=i?i:j,l=h&&(h.indexOf("http://")>-1||h.indexOf("https://")>-1||h.indexOf("file://")>-1),m={type:t.PARTICIPANT,fromParticipantName:g,longName:h,raw:a};if(l){var n=SEQ.parser.imageCache[h];if(n)return n.inUse=!0,c(g,0,0,m,null,k,n.image),m;m.loadingImage=!0;var o=b+1,p=new Image;return p.crossOrigin="Anonymous",p.onerror=function(){var a=SEQ.textUtil.parseTextData("Error loading image");c(g,0,0,m,a,k),d(o)},p.onload=function(){SEQ.parser.imageCache[h]={image:p,inUse:!0},c(g,0,0,m,null,k,p),d(o)},p.src=h,m}if(h)var q=SEQ.textUtil.parseTextData(h);if(f!=t.PARTICIPANT){var u;e[s.ICON_UNICODE]&&(u=String.fromCodePoint(parseInt(e[s.ICON_UNICODE],16))),c(g,0,0,m,q,k,null,SEQ.participantTypes[f],u)}else c(g,0,0,m,q,k);return m}}function b(a,b,c){SEQ.parser.participantExists(a)||d(a);var e=SEQ.parser.diagram.participantsByName[a];e.timelineLeftWidth<b&&(e.timelineLeftWidth=b),e.timelineRightWidth<c&&(e.timelineRightWidth=c)}function c(a,b,c,f,g,h,i,j,k){SEQ.parser.participantExists(a)||d(a,f,g,h,i,j,k);var l=SEQ.parser.diagram.participantsByName[a];return e(l,b,c),l}function d(a,b,c,d,e,f,g){var h,i;if(e)h=SEQ.metrics.data.participantImageHeight/e.height*e.width,i=SEQ.metrics.data.participantImageHeight;else if(f){var j,k=f.width(g);c?(j=c.width,i=f.height(g)+c.height):(j=SEQ.metrics.calcWidth(a),i=f.height(g)+SEQ.metrics.data.textLineHeight+SEQ.metrics.data.textTopBottomPadding),h=k>j?k:j}else c?(h=c.width+2*SEQ.metrics.data.participantPadding+SEQ.metrics.data.participantTypeLineWeight,i=c.height+2*SEQ.metrics.data.participantTopBottomPadding+SEQ.metrics.data.participantBoxLineWeight):(h=SEQ.metrics.calcWidth(a)+2*SEQ.metrics.data.participantPadding+SEQ.metrics.data.participantTypeLineWeight,i=SEQ.metrics.data.textLineHeight+SEQ.metrics.data.textTopBottomPadding+2*SEQ.metrics.data.participantTopBottomPadding+SEQ.metrics.data.participantTypeLineWeight);var l={type:SEQ.entityParticipant.Type.PARTICIPANT,name:a,font:SEQ.main.getFontNormal(),width:h,height:i,entityLeftWidth:0,entityRightWidth:0,timelineLeftWidth:0,timelineRightWidth:0,longNameTextData:c,image:e,participantType:f,iconUnicode:g,color:d,entry:b,createPosY:[],destroyPosY:[],collisionTypeAreas:m};!SEQ.parser.diagram.createdParticipantNames[a]&&i>SEQ.parser.diagram.participantMaxHeight&&(SEQ.parser.diagram.participantMaxHeight=i),SEQ.parser.diagram.participantsByName[a]=l,SEQ.parser.diagram.participants.push(l)}function e(a,b,c){a.entityLeftWidth<b&&(a.entityLeftWidth=b),a.entityRightWidth<c&&(a.entityRightWidth=c)}function f(a,b,c){SEQ.parser.participantExists(a)||d(a),SEQ.parser.participantExists(b)||d(b);var f,h=SEQ.parser.diagram.participantsByName[a],i=SEQ.parser.diagram.participantsByName[b],j=SEQ.parser.diagram.participants.indexOf(h),k=SEQ.parser.diagram.participants.indexOf(i),l=Math.abs(j-k);if(l>2){var m=g(j,k,SEQ.parser.diagram.participants),n=c-m;f=n/2}else f=2===l?c/2:c;f>0&&(j<k?(e(h,0,f),e(i,f,0)):(e(h,f,0),e(i,0,f)))}function g(a,b){for(var c=a<b?{low:a,high:b}:{low:b,high:a},d=0,e=c.low+1;e<=c.high;e++){var f=SEQ.parser.diagram.participants[e-1],g=SEQ.parser.diagram.participants[e];if(e!=c.low+1&&e!=c.high){var h=(f?f.width/2+SEQ.metrics.data.participantMarginSide:0)+g.width/2+SEQ.metrics.data.participantMarginSide,i=f&&f.entityRightWidth>g.entityLeftWidth?f.entityRightWidth:g.entityLeftWidth;d+=Math.max(h,i)}}return d}function h(a,b,c,d){if(!a.createPosY.length){var e=SEQ.metrics.data.participantMarginTop;SEQ.parser.diagram.title&&!c&&(e+=SEQ.parser.diagram.title.totalHeight),i(a,b,e,d)}}function i(a,b,c,d){if(a.image){c+=SEQ.parser.diagram.participantMaxHeight-SEQ.metrics.data.participantImageHeight;var e=a.posX-a.width/2;b.beginPath(),b.save(),b.rect(e,c,a.width,a.height),b.fillStyle="white",b.fill(),b.restore(),b.drawImage(a.image,e,c,a.width,a.height)}else a.participantType?(a.participantType.paint(b,a,SEQ.parser.diagram.participantMaxHeight,c),j(a,b,SEQ.parser.diagram.participantMaxHeight,c,d)):(k(a,b,SEQ.parser.diagram.participantMaxHeight,c),c-=SEQ.metrics.data.participantTopBottomPadding,j(a,b,SEQ.parser.diagram.participantMaxHeight,c,d))}function j(a,b,c,d,e){if(b.save(),a.longNameTextData)SEQ.textUtil.fillTextParticipant(b,e,a.longNameTextData.parsedLines,a.posX,d+c-a.longNameTextData.height);else{var f=SEQ.metrics.calcWidth(a.name,a.font);b.font=a.font,b.fillText(a.name,a.posX-f/2,d+c-SEQ.metrics.data.textTopBottomPadding)}b.restore()}function k(a,b,c,d){var e=d+c-a.height+SEQ.metrics.data.participantTypeLineWeight,f=a.width;b.beginPath(),b.save(),b.rect(a.posX-f/2,e,f,a.height-SEQ.metrics.data.participantTypeLineWeight),a.color?b.fillStyle=a.color:b.fillStyle="white",b.fill(),b.lineWidth=SEQ.metrics.data.participantBoxLineWeight,b.stroke(),b.restore()}function l(a,b,c){for(var d=SEQ.parser.diagram.participants,e=0;e<d.length;e++){var f=d[e],g=[];SEQ.parser.diagram.entries.forEach(function(a){a.activation&&a.fromParticipantName===f.name&&a.posY<=b&&(a.endPosY>=b||!a.endPosY)&&g.push(a)});var h,i=g.length?SEQ.metrics.data.activationSideWidth:0,j=g.length?SEQ.entityActivation.calcActivationCenterDiff(g)+SEQ.metrics.data.activationSideWidth:0;h=c?SEQ.metrics.data.dragAndDropInteractionMargin:f.width/2;var k=SEQ.parser.diagram.title?SEQ.parser.diagram.title.totalHeight:0,l=k+SEQ.metrics.data.participantMarginTop+SEQ.parser.diagram.participantMaxHeight,m=f.posX-h-i,n=f.posX+h+j,o=l-f.height;if(a>m&&a<n&&(!b||b>o))return f}}function m(){var a=SEQ.parser.diagram.title?SEQ.parser.diagram.title.totalHeight:0,b=a+SEQ.metrics.data.participantMarginTop+SEQ.parser.diagram.participantMaxHeight,c=[];return c.push({minX:this.posX-this.width/2,maxX:this.posX+this.width/2,minY:b-this.height,maxY:b,type:"pointer"}),c}function n(a){return t.PARTICIPANT===a}var o="((?:[^\\*#<>\\-:\\,\\=\\s]+[^#<>\\,:]*[^\\*#<>\\-:\\,\\=\\s]+)|(?:[^\\*#<>\\-:\\,\\=\\s]+))",p="(?:\\s?(#[a-fA-F0-9]{6})|(?:\\s?#)([a-zA-Z]{3,20}))",q=p+"?",r=new RegExp('^\\s*(?:(participant|actor|boundary|control|entity|database)|(fontawesome|materialdesignicons)\\s([a-fA-F0-9]{4}))\\s(?:(")(.+)(")\\s(as)\\s)?'+o+q),s={TYPE:1,ICON_FONT_TYPE:2,ICON_UNICODE:3,QUOTE_1:4,LONG_NAME:5,QUOTE_2:6,AS:7,ALIAS:8,COLOR_HEX:9,COLOR_NAME:10},t={PARTICIPANT:"participant",ACTOR:"actor",BOUNDARY:"boundary",CONTROL:"control",ENTITY:"entity",DATABASE:"database",FONT_AWESOME:"fontawesome",MATERIAL_DESIGN_ICONS:"materialdesignicons"};return{parse:a,paint:h,paintParticipant:i,findParticipantXCollision:l,storeParticipantWithDefinedWidths:c,storeParticipantWithTimelineWidths:b,storeParticipantsAndCalcWidths:f,updateParticipantRequiredEntityWidth:e,isType:n,Type:t,nameGroup:o,colorGroup:q,colorGroupMandatory:p,regExp:r,groups:s}}();var SEQ=SEQ||{};SEQ.entityDivider=function(){function a(a){var f=h.exec(a);if(null!=f&&f.length>i.TEXT){var g=SEQ.textUtil.parseTextData(f[i.TEXT]),k=f[i.COLOR_NAME],l=f[i.COLOR_HEX],m=k?k:l;return{type:j.DIVIDER,textData:g,color:m,totalHeight:g.height+2*SEQ.metrics.data.textPadding,totalWidth:g.width+2*SEQ.metrics.data.textPadding+2*SEQ.metrics.data.boxBleed,topMargin:SEQ.metrics.data.entityMarginTop,raw:a,paint:c,updatePos:b,collision:d,collisionTypeAreas:e}}}function b(a,b){a.posY=b}function c(a,b,c,d){function e(){return 1===a.textData.lines.length&&""===a.textData.lines[0]}var f=SEQ.parser.diagram.participants,g=f[0].posX,h=f[f.length-1].posX,i=Math.abs(g-h),j=g<h?g:h,k=SEQ.metrics.data.dividerLineSpacing,l=SEQ.metrics.data.dividerBleed,m=a.posY-a.totalHeight/2;if(b.beginPath(),b.moveTo(j-l,m-k),b.lineTo(j+i+l,m-k),b.moveTo(j-l,m),b.lineTo(j+i+l,m),b.moveTo(j-l,m+k),b.lineTo(j+i+l,m+k),b.stroke(),!e()){var n=a.posY-a.totalHeight,o=j+i/2-a.totalWidth/2;b.beginPath(),b.moveTo(o,n),b.lineTo(o+a.totalWidth,n),b.lineTo(o+a.totalWidth,n+a.totalHeight),b.lineTo(o,n+a.totalHeight),b.closePath();var p=b.fillStyle;a.color?b.fillStyle=a.color:b.fillStyle="white",b.fill(),b.fillStyle=p,b.stroke();var q=j+i/2-a.textData.width/2;SEQ.textUtil.fillText(b,c,a.textData.parsedLines,q,a.posY-a.totalHeight/2-a.textData.height/2)}}function d(a){var b,c,d=SEQ.parser.diagram.participants,e=d[0].posX,f=d[d.length-1].posX;e<f?(b=e,c=f):(b=e,c=f);var g=b-a.totalWidth/2,h=c+a.totalWidth/2,i=b-SEQ.metrics.data.dividerBleed,j=c+SEQ.metrics.data.dividerBleed;return b==c?(b=g<i?g:i,c=h>j?h:j):(b=i,c=j),{main:{startX:b,endX:c,startY:a.posY,endY:a.posY-a.totalHeight}}}function e(){var a=this.collision(this).main;return[{minX:a.startX,maxX:a.endX,minY:a.endY,maxY:a.startY,type:"pointer"}]}function f(a){return j.DIVIDER+a.replace(/\n/g,"\\n")+j.DIVIDER}function g(a){return j.DIVIDER===a}var h=new RegExp("^\\s*(==)(.*)(==)"+SEQ.entityParticipant.colorGroup),i={EQUALS_1:1,TEXT:2,EQUALS_2:3,COLOR_HEX:4,COLOR_NAME:5},j={DIVIDER:"=="};return{parse:a,paint:c,collision:d,build:f,isType:g,Type:j,groups:i,regExp:h}}();var SEQ=SEQ||{};SEQ.entityTitle=function(){function a(a){var b=d.exec(a);if(null!=b&&b.length>e.VALUE)return{type:f.TITLE,title:b[e.VALUE],totalHeight:SEQ.metrics.data.textLineHeight*SEQ.main.fontSizeTitleRatio+SEQ.metrics.data.baseSpaceMetric,topMargin:0,font:SEQ.main.getFontTitle(),raw:a}}function b(a){var b=SEQ.parser.diagram,c=SEQ.main.getDiagramContext();c.font=b.title.font,c.fillStyle="black";var d=SEQ.metrics.calcWidth(b.title.title);c.fillText(b.title.title,a.width/2-d/2,b.title.topMargin+b.title.totalHeight-SEQ.metrics.data.baseSpaceMetric)}function c(a){return a===f.TITLE}var d=new RegExp("^\\s*(title) (.+)","i"),e={TITLE:1,VALUE:2},f={TITLE:"title"};return{parse:a,paint:b,isType:c,Type:f,regExp:d,groups:e}}();var SEQ=SEQ||{};SEQ.entityFontFamily=function(){function a(a){var d=b.exec(a);if(null!=d&&d.length>c.NAME){var e=d[c.NAME];return{raw:a,fontFamily:e}}}var b=new RegExp("^\\s*(fontfamily)\\s(.+)"),c={FONT_FAMILY:1,NAME:2},d={FONT_FAMILY:"fontfamily"};return{parse:a,regExp:b,groups:c,Type:d}}();var SEQ=SEQ||{};SEQ.entityMessage=function(){function a(a,j,k,n,p,q,r){var s=t.exec(a);if(null!=s&&s.length>v.TEXT){var u,w,x=s[v.TYPE];x.indexOf(">")>-1?(u=s[v.PARTICIPANT_1],w=s[v.PARTICIPANT_2]):(u=s[v.PARTICIPANT_2],w=s[v.PARTICIPANT_1]);var y,z=f([s[v.COLOR_HEX_3],s[v.COLOR_NAME_4],s[v.COLOR_HEX_5],s[v.COLOR_NAME_6],s[v.COLOR_HEX_7],s[v.COLOR_NAME_8]]),A=k?n:null,B=SEQ.textUtil.parseTextData(s[v.TEXT],A),C=B.height;if(u===w){y=B.width+SEQ.metrics.data.messageArrowWidth+SEQ.metrics.data.textPadding+SEQ.metrics.data.messageSelfRefSideMargin;var D=SEQ.metrics.data.messageSelfRefWidth,E=SEQ.metrics.data.messageSelfRefSideMargin;y=y>D+E?y:D+E,C+=SEQ.metrics.data.messageSelfRefHeight}else y=B.width+2*SEQ.metrics.data.messageArrowWidth+2*SEQ.metrics.data.textPadding;if(p)var F=g(C,x,u,w);if(x.indexOf("*")>-1){var G=SEQ.parser.diagram.participantsByName[w];G||(SEQ.entityParticipant.storeParticipantWithDefinedWidths(w,0,0),G=SEQ.parser.diagram.participantsByName[w]);var H=G.height/2,I=C-H;C=G.height,I>0&&(C+=I),G.createPosY.push(q+r+SEQ.metrics.data.entityMarginTop+C),y+=G.width/2}return{type:x,fromParticipantName:u,toParticipantName:w,participantToCreate:G,textData:B,color:z,totalHeight:C,totalWidth:y,topMargin:SEQ.metrics.data.entityMarginTop,autoNumber:A,parallel:j,linearRequiredHeight:F,linear:p,raw:a,message:!0,paint:i,updatePos:b,collision:l,collisionTypeAreas:m,buildRaw:o,calcPosX:h,updateActivationPosDiff:e,updateEnclosingFragments:d,updateParticipantWidths:c}}}function b(a,b,c,d){a.posY=b,a.fromPosX=c,a.toPosX=d}function c(a){if(a.fromParticipantName===a.toParticipantName)SEQ.entityParticipant.storeParticipantWithDefinedWidths(a.fromParticipantName,0,a.totalWidth);else{var b=SEQ.parser.diagram.participants.indexOf(SEQ.parser.diagram.participantsByName[a.fromParticipantName]),c=SEQ.parser.diagram.participants.indexOf(SEQ.parser.diagram.participantsByName[a.toParticipantName]);b<c?SEQ.entityParticipant.storeParticipantsAndCalcWidths(a.fromParticipantName,a.toParticipantName,a.totalWidth):SEQ.entityParticipant.storeParticipantsAndCalcWidths(a.fromParticipantName,a.toParticipantName,a.totalWidth)}}function d(a){if(a.fromParticipantName===a.toParticipantName)SEQ.entityFragment.storeEnclosedEntriesData(a.fromParticipantName,0,a.totalWidth,0,a.fromActivationXDiff);else{var b=SEQ.parser.diagram.participants.indexOf(SEQ.parser.diagram.participantsByName[a.fromParticipantName]),c=SEQ.parser.diagram.participants.indexOf(SEQ.parser.diagram.participantsByName[a.toParticipantName]),d=0;a.participantToCreate&&(d=a.participantToCreate.width/2+SEQ.metrics.data.entryMarginSide),b<c?(SEQ.entityFragment.storeEnclosedEntriesData(a.fromParticipantName,0,0,0,0),SEQ.entityFragment.storeEnclosedEntriesData(a.toParticipantName,d,d,0,a.toActivationXDiff)):(SEQ.entityFragment.storeEnclosedEntriesData(a.fromParticipantName,0,0,0,0),SEQ.entityFragment.storeEnclosedEntriesData(a.toParticipantName,d,d,a.toActivationXDiff,0))}}function e(a,b){var c=SEQ.parser.diagram.ongoingActivations,d=SEQ.parser.diagram.participants.indexOf(SEQ.parser.diagram.participantsByName[a.fromParticipantName]),e=SEQ.parser.diagram.participants.indexOf(SEQ.parser.diagram.participantsByName[a.toParticipantName]),f=0,g=0,h=c[a.fromParticipantName]||[],i=c[a.toParticipantName]||[];a.fromParticipantName===a.toParticipantName?(h.length&&(f+=SEQ.entityActivation.calcActivationCenterDiff(h)+SEQ.metrics.data.activationSideWidth,g+=SEQ.entityActivation.calcActivationCenterDiff(i)+SEQ.metrics.data.activationSideWidth),"undefined"==typeof a.fromActivationXDiffOriginal&&(a.fromActivationXDiffOriginal=a.fromActivationXDiff)):d<e?(h.length&&(f+=SEQ.entityActivation.calcActivationCenterDiff(h)+SEQ.metrics.data.activationSideWidth),i.length&&(g+=SEQ.entityActivation.calcActivationCenterDiff(i)-SEQ.metrics.data.activationSideWidth)):(h.length&&(f+=SEQ.entityActivation.calcActivationCenterDiff(h)-SEQ.metrics.data.activationSideWidth),i.length&&(g+=SEQ.entityActivation.calcActivationCenterDiff(i)+SEQ.metrics.data.activationSideWidth)),b?(b.fromParticipantName===a.fromParticipantName&&(a.fromActivationXDiff=f),b.fromParticipantName===a.toParticipantName&&(a.toActivationXDiff=g)):(a.fromActivationXDiff=f,a.toActivationXDiff=g);
}function f(a){for(var b=0;b<a.length;b++){var c=a[b];if(c)return c}}function g(a,b,c,d){var e,f,g=SEQ.parser.diagram;if(g.entries.length>0)for(var h=g.entries.length-1;h>=0;h--){var i=g.entries[h];if(i&&i.type){e=i,f=e.type.trim().replace(u,"");break}}var j=b.trim().replace(u,"");if(e&&s.exec(f)&&f===j&&e.toParticipantName===c){var k=g.participantsByName,l=g.participants,m=k[e.fromParticipantName],n=k[e.toParticipantName],o=k[c],p=k[d],q=l.indexOf(m),r=l.indexOf(n),t=l.indexOf(o),v=l.indexOf(p);if(q<r&&(t<=v||!p)||q>r&&t>=v)return a<=e.totalHeight?0:a-e.totalHeight}return null}function h(a){var b=SEQ.parser.diagram.participantsByName[a.fromParticipantName].posX,c=SEQ.parser.diagram.participantsByName[a.toParticipantName].posX;return b+=a.fromParticipantName===a.toParticipantName?"undefined"==typeof a.fromActivationXDiffOriginal?a.fromActivationXDiff:a.fromActivationXDiffOriginal:a.fromActivationXDiff,a.participantToCreate?c>b?c-=a.participantToCreate.width/2:c+=a.participantToCreate.width/2:c+=a.toActivationXDiff,{fromX:b,toX:c}}function i(a,b,c,d){var e,f;if(d)e=a.fromPosX,f=a.toPosX;else{var g=h(a);e=g.fromX,f=g.toX}var i,k,l,m=e>f?f:e,n=a.fromParticipantName===a.toParticipantName&&Math.abs(e-f)<SEQ.metrics.data.messageCreatorInteractionMargin+a.fromActivationXDiff;if(n)i=f+SEQ.metrics.data.messageArrowWidth+SEQ.metrics.data.textPadding,k=a.posY-a.totalHeight,l=a.posY;else{if(a.participantToCreate){k=a.posY-a.participantToCreate.height/2-a.textData.height,l=a.posY-a.participantToCreate.height/2;var o=l-SEQ.parser.diagram.participantMaxHeight+a.participantToCreate.height/2-SEQ.metrics.data.participantTypeLineWeight/2;SEQ.entityParticipant.paintParticipant(a.participantToCreate,b,o)}else k=a.posY-a.totalHeight,l=a.posY;var p=Math.abs(e-f);i=m+p/2-a.textData.width/2}SEQ.textUtil.fillText(b,c,a.textData.parsedLines,i,k,a.autoNumber,a.textData.autoNumberWidth,!0),c?j(b,a.type,l,e,f,n):j(b,a.type,l,e,f,n,a.color)}function j(a,b,c,d,e,f,g){a.save(),g&&(a.strokeStyle=g,a.fillStyle=g),a.beginPath(),b.indexOf("--")>-1&&void 0!==a.setLineDash&&a.setLineDash([SEQ.metrics.data.messageLineDashWidth]);var h=d<e&&!f;if(f){var i=SEQ.metrics.data.messageSelfRefHeight,j=SEQ.metrics.data.messageSelfRefWidth+Math.abs(d-e);a.moveTo(d,c-i),a.lineTo(d+j,c-i),a.lineTo(d+j,c),a.lineTo(e+.2*SEQ.metrics.data.messageArrowWidth,c),a.stroke()}else a.moveTo(d,c),h?a.lineTo(e-.2*SEQ.metrics.data.messageArrowWidth,c):a.lineTo(e+.2*SEQ.metrics.data.messageArrowWidth,c),a.stroke();var l=b.indexOf(">>")>-1||b.indexOf("<<")>-1;k(c,h,e,a,l),b.indexOf(">")>-1&&b.indexOf("<")>-1&&k(c,e<d,d,a,l),a.restore()}function k(a,b,c,d,e){d.setLineDash([]);var f,g,h=SEQ.metrics.data.messageArrowWidth;b?(f=-h,g=-SEQ.metrics.data.diagramLineWeight):(f=h,g=SEQ.metrics.data.diagramLineWeight),e&&(c+=g,f-=g),d.beginPath(),d.moveTo(c+f,a-h/2),d.lineTo(c,a),d.lineTo(c+f,a+h/2),e?d.stroke():(d.closePath(),d.fill())}function l(a){var b,c,d,e,f=h(a),g=f.fromX,i=f.toX;if(a.participantToCreate){var j,k;return g<i?(j=i,k=i+a.participantToCreate.width,i+=a.participantToCreate.width,g+=SEQ.metrics.data.messageInteractionMargin):(j=i-a.participantToCreate.width,k=i,i-=a.participantToCreate.width,g-=SEQ.metrics.data.messageInteractionMargin),g<i?(b=g,c=i):(b=i,c=g),d=a.posY,e=a.posY-a.totalHeight,{main:{startX:b,endX:c,startY:d,endY:e},participantToCreate:{startX:j,endX:k,startY:d,endY:e}}}return a.fromParticipantName===a.toParticipantName?(b=g,c=i+a.totalWidth-SEQ.metrics.data.messageSelfRefSideMargin):g<i?(b=g,c=i):(b=i,c=g),b+=SEQ.metrics.data.messageInteractionMargin,c-=SEQ.metrics.data.messageInteractionMargin,d=a.posY+SEQ.metrics.data.collisionBleed,e=a.posY-a.totalHeight,{main:{startX:b,endX:c,startY:d,endY:e}}}function m(){var a=this.collision(this).main,b=[];if(this.collision(this).participantToCreate){var c=h(this);c.fromX<c.toX?b.push({minX:a.startX,maxX:a.startX+SEQ.metrics.data.entryMoverXCollisionWidth-SEQ.metrics.data.messageInteractionMargin,minY:a.endY,maxY:a.startY,type:"ew-resize"},{minX:a.startX+SEQ.metrics.data.entryMoverXCollisionWidth-SEQ.metrics.data.messageInteractionMargin,maxX:a.endX,minY:a.endY,maxY:a.startY,type:"pointer"}):b.push({minX:a.endX-SEQ.metrics.data.entryMoverXCollisionWidth+SEQ.metrics.data.messageInteractionMargin,maxX:a.endX,minY:a.endY,maxY:a.startY,type:"ew-resize"},{minX:a.startX,maxX:a.endX-SEQ.metrics.data.entryMoverXCollisionWidth+SEQ.metrics.data.messageInteractionMargin,minY:a.endY,maxY:a.startY,type:"pointer"})}else b.push({minX:a.startX,maxX:a.startX+SEQ.metrics.data.entryMoverXCollisionWidth-SEQ.metrics.data.messageInteractionMargin,minY:a.endY,maxY:a.startY,type:"ew-resize"},{minX:a.endX-SEQ.metrics.data.entryMoverXCollisionWidth+SEQ.metrics.data.messageInteractionMargin,maxX:a.endX,minY:a.endY,maxY:a.startY,type:"ew-resize"},{minX:a.startX+SEQ.metrics.data.entryMoverXCollisionWidth-SEQ.metrics.data.messageInteractionMargin,maxX:a.endX-SEQ.metrics.data.entryMoverXCollisionWidth+SEQ.metrics.data.messageInteractionMargin,minY:a.endY,maxY:a.startY,type:"pointer"});return b}function n(a,b,c,d){return/>/.exec(a)?b+a+c+":"+d.replace(/\n/g,"\\n"):c+a+b+":"+d.replace(/\n/g,"\\n")}function o(a){return/>/.exec(a.type)?a.fromParticipantName+a.type+a.toParticipantName+":"+SEQ.textUtil.buildSourceText(a.textData):a.toParticipantName+a.type+a.fromParticipantName+":"+SEQ.textUtil.buildSourceText(a.textData)}function p(a){return null!=s.exec(a)}function q(a){var b=t.exec(a);if(null!=b&&b.length>v.TYPE&&b[v.TYPE].indexOf("*")>-1)return b[v.TYPE].indexOf(">")>-1?b[v.PARTICIPANT_2]:b[v.PARTICIPANT_1]}var r="(\\s*--?"+SEQ.entityParticipant.colorGroup+">?>\\s*\\*?\\s*|\\s*\\*?\\s*<<?"+SEQ.entityParticipant.colorGroup+"-?-\\s*|\\s*<<?-?-"+SEQ.entityParticipant.colorGroup+">?>\\s*)",s=new RegExp(r),t=new RegExp("^\\s*"+SEQ.entityParticipant.nameGroup+r+SEQ.entityParticipant.nameGroup+"\\s?:\\s?(.*)"),u=new RegExp(SEQ.entityParticipant.colorGroupMandatory),v={PARTICIPANT_1:1,TYPE:2,COLOR_HEX_3:3,COLOR_NAME_4:4,COLOR_HEX_5:5,COLOR_NAME_6:6,COLOR_HEX_7:7,COLOR_NAME_8:8,PARTICIPANT_2:9,TEXT:10},w={REQ_FORWARD_SYNC:"->",RESP_FORWARD_SYNC:"-->",REQ_FORWARD_ASYNC:"->>",RESP_FORWARD_ASYNC:"-->>",REQ_BACKWARD_SYNC:"<-",RESP_BACKWARD_SYNC:"<--",REQ_BACKWARD_ASYNC:"<<-",RESP_BACKWARD_ASYNC:"<<--"};return{parse:a,paint:i,collision:l,build:n,paintArrowHead:k,isType:p,createdParticipant:q,Type:w,regExpArrow:s,regExp:t,groups:v}}();var SEQ=SEQ||{};SEQ.entityNoteBoxLeftRight=function(){function a(a,j){var l=m.exec(a);if(null!=l&&l.length>n.TEXT){var o=SEQ.textUtil.parseTextData(l[n.TEXT]),p=l[n.TYPE],q=l[n.PARTICIPANT_FROM],r=l[n.COLOR_NAME],s=l[n.COLOR_HEX],t=r?r:s,u=o.width+2*SEQ.metrics.data.textPadding+2*SEQ.metrics.data.boxBleed+2*SEQ.metrics.data.entryMarginSide,v=l[n.SIDE];return{type:p,fromParticipantName:q,side:v,textData:o,color:t,parallel:j,totalHeight:o.height+2*SEQ.metrics.data.textPadding,totalWidth:u,topMargin:SEQ.metrics.data.entityMarginTop,raw:a,paint:g,updatePos:b,collision:h,collisionTypeAreas:i,buildRaw:k,calcPosX:f,updateActivationPosDiff:e,updateEnclosingFragments:d,updateParticipantWidths:c}}}function b(a,b,c){a.posY=b,a.fromPosX=c}function c(a){p.LEFT===a.side?SEQ.entityParticipant.storeParticipantWithDefinedWidths(a.fromParticipantName,a.totalWidth,0):SEQ.entityParticipant.storeParticipantWithDefinedWidths(a.fromParticipantName,0,a.totalWidth)}function d(a){p.LEFT===a.side?SEQ.entityFragment.storeEnclosedEntriesData(a.fromParticipantName,a.totalWidth,0,Math.abs(a.fromActivationXDiff),0):SEQ.entityFragment.storeEnclosedEntriesData(a.fromParticipantName,0,a.totalWidth,0,a.fromActivationXDiff)}function e(a){var b=SEQ.parser.diagram.ongoingActivations,c=0,d=b[a.fromParticipantName]||[];a.side===SEQ.entityNoteBoxLeftRight.NotePosition.LEFT&&d.length?c-=SEQ.metrics.data.activationSideWidth:a.side===SEQ.entityNoteBoxLeftRight.NotePosition.RIGHT&&d.length&&(c+=SEQ.entityActivation.calcActivationCenterDiff(d)+SEQ.metrics.data.activationSideWidth),a.fromActivationXDiff=c}function f(a){var b=SEQ.parser.diagram.participantsByName[a.fromParticipantName].posX;return b+=a.fromActivationXDiff,{fromX:b}}function g(a,b,c,d){var e;if(d)e=a.fromPosX;else{var g=f(a);e=g.fromX}b.beginPath();var h,i=SEQ.metrics.data.entryMarginSide;a.side===SEQ.entityNoteBoxLeftRight.NotePosition.LEFT?(h=e-a.totalWidth+i,b.moveTo(e,a.posY-a.totalHeight/2),b.lineTo(e-i,a.posY-a.totalHeight/2)):a.side===SEQ.entityNoteBoxLeftRight.NotePosition.RIGHT&&(h=e+i,b.moveTo(e,a.posY-a.totalHeight/2),b.lineTo(e+i,a.posY-a.totalHeight/2)),SEQ.entityNoteBoxOver.paintNoteOrBox(a,b,h,a.totalWidth-2*i);var j=h-i+a.totalWidth/2-a.textData.width/2,k=a.posY-a.totalHeight/2-a.textData.height/2;SEQ.textUtil.fillText(b,c,a.textData.parsedLines,j,k)}function h(a){var b,c,d=f(a),e=d.fromX,g=SEQ.metrics.data.entryMarginSide;return a.side===SEQ.entityNoteBoxLeftRight.NotePosition.LEFT?(b=e-a.totalWidth,c=e):a.side===SEQ.entityNoteBoxLeftRight.NotePosition.RIGHT&&(b=e,c=e+a.totalWidth),b+=g,c-=g,{main:{startX:b,endX:c,startY:a.posY,endY:a.posY-a.totalHeight}}}function i(){var a=this.collision(this).main,b=[];return b.push({minX:a.startX,maxX:a.endX,minY:a.endY,maxY:a.startY,type:"pointer"}),b}function j(a,b,c,d){return a+" "+b+" "+c+":"+d.replace(/\n/g,"\\n")}function k(a){var b="";return a.color&&(b=a.color.indexOf("#")>-1?" "+a.color:" #"+a.color),a.type+" "+a.side+" "+a.fromParticipantName+b+":"+SEQ.textUtil.buildSourceText(a.textData)}function l(a){return o.NOTE===a||o.BOX===a||o.ABOX===a||o.RBOX===a||SEQ.entityNoteBoxOver.Type.REF===a}var m=new RegExp("^\\s*(note|box|rbox|abox)\\s(left\\sof|right\\sof)\\s"+SEQ.entityParticipant.nameGroup+"\\s?"+SEQ.entityParticipant.colorGroup+"\\s?:\\s?(.*)"),n={TYPE:1,SIDE:2,PARTICIPANT_FROM:3,COLOR_HEX:4,COLOR_NAME:5,TEXT:6},o={NOTE:"note",BOX:"box",RBOX:"rbox",ABOX:"abox"},p={LEFT:"left of",RIGHT:"right of"};return{parse:a,paint:g,collision:h,build:j,regExp:m,Type:o,isType:l,NotePosition:p,groups:n}}();var SEQ=SEQ||{};SEQ.entityNoteBoxOver=function(){function a(a,g){var h=p.exec(a);if(null!=h&&h.length>q.TEXT){var i,j=SEQ.textUtil.parseTextData(h[q.TEXT]),k=h[q.TYPE],n=h[q.PARTICIPANT_TO],t=h[q.PARTICIPANT_FROM],u=h[q.COLOR_NAME],v=h[q.COLOR_HEX],w=u?u:v;i=n?j.width+2*SEQ.metrics.data.textPadding:j.width+2*SEQ.metrics.data.textPadding+2*SEQ.metrics.data.boxBleed+2*SEQ.metrics.data.entryMarginSide;var x=j.height+2*SEQ.metrics.data.textPadding;return r.REF===k&&(x+=SEQ.metrics.data.fragmentHeight),{type:k,notePosition:s.OVER,fromParticipantName:t,toParticipantName:n,side:h[q.SIDE],textData:j,color:w,parallel:g,totalHeight:x,totalWidth:i,topMargin:SEQ.metrics.data.entityMarginTop,raw:a,paint:f,updatePos:b,collision:l,collisionTypeAreas:m,buildRaw:o,calcPosX:e,updateEnclosingFragments:d,updateParticipantWidths:c}}}function b(a,b,c,d){a.posY=b,a.fromPosX=c,a.toPosX=d}function c(a){if(a.toParticipantName)SEQ.entityParticipant.storeParticipantsAndCalcWidths(a.fromParticipantName,a.toParticipantName,a.totalWidth);else{var b=a.totalWidth/2;SEQ.entityParticipant.storeParticipantWithDefinedWidths(a.fromParticipantName,b,b)}}function d(a){if(a.toParticipantName)SEQ.entityFragment.storeEnclosedEntriesData(a.fromParticipantName,0,0,0,0),SEQ.entityFragment.storeEnclosedEntriesData(a.toParticipantName,0,0,0,0);else{var b=a.totalWidth/2;SEQ.entityFragment.storeEnclosedEntriesData(a.fromParticipantName,b,b,0,0)}}function e(a){var b=SEQ.parser.diagram.participantsByName[a.fromParticipantName].posX,c=null;return a.toParticipantName&&(c=SEQ.parser.diagram.participantsByName[a.toParticipantName].posX),{fromX:b,toX:c}}function f(a,b,c,d){var f,h;if(d)f=a.fromPosX,a.toParticipantName&&(h=a.toPosX);else{var i=e(a);f=i.fromX,h=i.toX}b.beginPath();var j,k,l,m,n=SEQ.metrics.data.boxBleed;if(h){var o=h>f?f:h;j=o-n,m=Math.abs(f-h)+2*n,k=j+m/2-a.textData.width/2,l=a.posY-a.totalHeight/2-a.textData.height/2}else j=f-a.totalWidth/2+SEQ.metrics.data.entryMarginSide,m=a.totalWidth-2*SEQ.metrics.data.entryMarginSide,k=f-a.textData.width/2,l=a.posY-a.totalHeight/2-a.textData.height/2;r.REF===a.type?(b.save(),b.lineWidth=SEQ.metrics.data.fragmentLineWeight,b.font="bold "+SEQ.main.getFontSmall(),SEQ.entityFragment.paintFragment(b,b.font,j,a.posY-a.totalHeight,SEQ.metrics.data.fragmentHeight,a.posY,0,j+m,a.type,!0),b.restore(),l+=SEQ.metrics.data.fragmentHeight/2-SEQ.metrics.data.fragmentLineWeight/2):g(a,b,j,m),SEQ.textUtil.fillText(b,c,a.textData.parsedLines,k,l)}function g(a,b,c,d){r.NOTE==a.type?h(b,c,a.posY,a.totalHeight,d,a.color):r.BOX==a.type?i(b,c,a.posY,a.totalHeight,d,a.color):r.RBOX==a.type?j(b,c,a.posY,a.totalHeight,d,a.color):r.ABOX==a.type&&k(b,c,a.posY,a.totalHeight,d,a.color)}function h(a,b,c,d,e,f){var g=SEQ.metrics.data.boxBleed;a.moveTo(b,c-d),a.lineTo(b+e-g,c-d),a.lineTo(b+e,c-d+g),a.lineTo(b+e,c),a.lineTo(b,c),a.lineTo(b,c-d);var h=a.fillStyle;f?a.fillStyle=f:a.fillStyle="white",a.fill(),a.moveTo(b+e-g,c-d),a.lineTo(b+e-g,c-d+g),a.lineTo(b+e,c-d+g),a.fillStyle=h,a.stroke()}function i(a,b,c,d,e,f){a.moveTo(b,c-d),a.lineTo(b+e,c-d),a.lineTo(b+e,c),a.lineTo(b,c),a.lineTo(b,c-d);var g=a.fillStyle;f?a.fillStyle=f:a.fillStyle="white",a.fill(),a.fillStyle=g,a.stroke()}function j(a,b,c,d,e,f){var g=SEQ.metrics.data.boxBleed;a.moveTo(b,c-d+g),a.arc(b+g,c-d+g,g,Math.PI,-Math.PI/2),a.lineTo(b+e-g,c-d),a.arc(b+e-g,c-d+g,g,-Math.PI/2,0),a.lineTo(b+e,c-g),a.arc(b+e-g,c-g,g,0,Math.PI/2),a.lineTo(b+g,c),a.arc(b+g,c-g,g,Math.PI/2,Math.PI),a.lineTo(b,c-d+g);var h=a.fillStyle;f?a.fillStyle=f:a.fillStyle="white",a.fill(),a.fillStyle=h,a.stroke()}function k(a,b,c,d,e,f){var g=SEQ.metrics.data.boxBleed;a.moveTo(b+g,c-d),a.lineTo(b+e-g,c-d),a.lineTo(b+e,c-d/2),a.lineTo(b+e-g,c),a.lineTo(b+g,c),a.lineTo(b,c-d/2),a.lineTo(b+g,c-d);var h=a.fillStyle;f?a.fillStyle=f:a.fillStyle="white",a.fill(),a.fillStyle=h,a.stroke()}function l(a){var b,c,d=e(a),f=d.fromX,g=d.toX;return g?(f<g?(b=f,c=g):(b=g,c=f),b-=SEQ.metrics.data.boxBleed,c+=SEQ.metrics.data.boxBleed):(b=f-a.totalWidth/2+SEQ.metrics.data.entryMarginSide,c=f+a.totalWidth/2-SEQ.metrics.data.entryMarginSide),{main:{startX:b,endX:c,startY:a.posY,endY:a.posY-a.totalHeight}}}function m(){var a=this.collision(this).main,b=[];return this.toParticipantName?b.push({minX:a.startX,maxX:a.startX+SEQ.metrics.data.entryMoverXCollisionWidth+SEQ.metrics.data.boxBleed,minY:a.endY,maxY:a.startY,type:"ew-resize"},{minX:a.endX-SEQ.metrics.data.entryMoverXCollisionWidth-SEQ.metrics.data.boxBleed,maxX:a.endX,minY:a.endY,maxY:a.startY,type:"ew-resize"},{minX:a.startX+SEQ.metrics.data.entryMoverXCollisionWidth+SEQ.metrics.data.boxBleed,maxX:a.endX-SEQ.metrics.data.entryMoverXCollisionWidth-SEQ.metrics.data.boxBleed,minY:a.endY,maxY:a.startY,type:"pointer"}):b.push({minX:a.startX,maxX:a.startX+SEQ.metrics.data.entryMoverXCollisionWidth,minY:a.endY,maxY:a.startY,type:"ew-resize"},{minX:a.endX-SEQ.metrics.data.entryMoverXCollisionWidth,maxX:a.endX,minY:a.endY,maxY:a.startY,type:"ew-resize"},{minX:a.startX+SEQ.metrics.data.entryMoverXCollisionWidth,maxX:a.endX-SEQ.metrics.data.entryMoverXCollisionWidth,minY:a.endY,maxY:a.startY,type:"pointer"}),b}function n(a,b,c){return a+" "+s.OVER+" "+b+":"+c.replace(/\n/g,"\\n")}function o(a){var b="";a.color&&(b=a.color.indexOf("#")>-1?" "+a.color:" #"+a.color);var c=a.toParticipantName?","+a.toParticipantName:"";return a.type+" "+a.side+" "+a.fromParticipantName+c+b+":"+SEQ.textUtil.buildSourceText(a.textData)}var p=new RegExp("^\\s*(note|box|rbox|abox|ref)\\s(over)\\s"+SEQ.entityParticipant.nameGroup+",?\\s?"+SEQ.entityParticipant.nameGroup+"?\\s?"+SEQ.entityParticipant.colorGroup+"\\s?:\\s?(.*)"),q={TYPE:1,SIDE:2,PARTICIPANT_FROM:3,PARTICIPANT_TO:4,COLOR_HEX:5,COLOR_NAME:6,TEXT:7},r={NOTE:"note",BOX:"box",RBOX:"rbox",ABOX:"abox",REF:"ref"},s={OVER:"over"};return{parse:a,paint:f,collision:l,build:n,paintNoteOrBox:g,Type:r,NotePosition:s,regExp:p,groups:q}}();var SEQ=SEQ||{};SEQ.entityAutoNumber=function(){function a(a){var d=b.exec(a);if(null!=d&&d.length>c.STATUS){var e,f=d[c.STATUS];if("on"===f)var g=!0;else"off"===f?g=!1:isNaN(f)?g=!0:(g=!0,e=f);return{raw:a,enabled:g,value:e}}}var b=new RegExp("^\\s*(autonumber)\\s?(on|off|[0-9]+)?"),c={AUTO_NUMBER:1,STATUS:2},d={AUTO_NUMBER:"autonumber"};return{parse:a,regExp:b,groups:c,Type:d}}();var SEQ=SEQ||{};SEQ.entityLinear=function(){function a(a){var d=b.exec(a);if(null!=d&&d.length>c.STATUS){var e=d[c.STATUS];if("on"===e)var f=!0;else f="off"!==e&&"end"!==e;return{raw:a,enabled:f}}}var b=new RegExp("^\\s*(linear)\\s?(on|off|end)?"),c={LINEAR:1,STATUS:2},d={LINEAR:"linear"};return{parse:a,regExp:b,groups:c,Type:d}}();var SEQ=SEQ||{};SEQ.entityFragment=function(){function a(a,b,c){var d=SEQ.parser.diagram.ongoingFragments,e=x.exec(a);if(null!=e&&e.length>y.OPERATOR){var f=e[y.TEXT],g=e[y.OPERATOR],h=e[y.GROUP_LABEL];if(h&&(h=h.trim(),g=z.GROUP,f=e[y.GROUP_CONDITION]),z.END!==g){if(z.ELSE===g){for(var i=!1,l=d.length-1;l>=0;l--){var m=d[l];if(m.type==z.ALT){var n={posY:b+c+SEQ.metrics.data.entityMarginTop+SEQ.metrics.data.fragmentHeight,totalHeight:SEQ.metrics.data.fragmentHeight,text:f};m.elseGuards.push(n),i=!0;break}}return i?{type:g,fragment:m,elseGuard:n,totalHeight:SEQ.metrics.data.fragmentHeight,topMargin:SEQ.metrics.data.entityMarginTop,raw:a,paint:k,updatePos:function(a,b){a.elseGuard.posY=b},collision:o,collisionTypeAreas:p}:{raw:a}}for(var r={type:g,groupLabel:h,text:f,font:"bold "+SEQ.main.getFontSmall(),enclosedEntitiesData:[],subFragments:[],elseGuards:[],leftWidth:0,rightWidth:0,topMargin:SEQ.metrics.data.entityMarginTop,posY:b+c+SEQ.metrics.data.entityMarginTop+SEQ.metrics.data.fragmentHeight,totalHeight:SEQ.metrics.data.fragmentHeight,raw:a},t=0;t<d.length;t++){var u=d[t];u.subFragments.push(r)}if(d.push(r),z.EXPANDABLE_PLUS===g){f||(f="");var v=SEQ.textUtil.parseTextData(f),w={type:g,fragment:r,textData:v,totalHeight:v.height+2*SEQ.metrics.data.textPadding+SEQ.metrics.data.fragmentHeight,topMargin:SEQ.metrics.data.entityMarginTop,raw:a,collision:s,collisionTypeAreas:q,paint:j};return r.startEntry=w,w}return{type:g,fragment:r,totalHeight:r.totalHeight,topMargin:r.topMargin,raw:a,paint:k,updatePos:function(a,b){a.fragment.posY=b},collision:o,collisionTypeAreas:p}}if(d.length>0){var A=d.pop();return A.endPosY=b+c,SEQ.parser.diagram.fragments.push(A),A.type===SEQ.entityFragment.Type.EXPANDABLE_PLUS?{type:g,fragment:A,totalHeight:0,topMargin:0,raw:a}:{type:g,fragment:A,totalHeight:0,topMargin:SEQ.metrics.data.entityMarginTop,raw:a,paint:k,updatePos:function(a,b){a.fragment.endPosY=b-a.fragment.topMargin},collision:o,collisionTypeAreas:p}}}}function b(a){for(var b=SEQ.parser.diagram.ongoingFragments,c=0;c<b.length;c++){var d=b[c];d.type===SEQ.entityFragment.Type.EXPANDABLE_PLUS&&a.fragment!=d&&(a.enclosingCollapsedFragment=d)}}function c(a,b,c,d,e){function f(a){for(var b=0;b<i.enclosedEntitiesData.length;b++){var c=i.enclosedEntitiesData[b];if(a==c.participantName)return c}}for(var g=SEQ.parser.diagram.ongoingFragments,h=0;h<g.length;h++){var i=g[h],j=f(a);j?(b>j.entityLeftWidth&&(j.entityLeftWidth=b),c>j.entityRightWidth&&(j.entityRightWidth=c),d>j.timelineLeftWidth&&(j.timelineLeftWidth=d),e>j.timelineRightWidth&&(j.timelineRightWidth=e)):i.enclosedEntitiesData.push({participantName:a,entityLeftWidth:b,entityRightWidth:c,timelineLeftWidth:d,timelineRightWidth:e})}}function d(a){if(a.toParticipantName)SEQ.entityParticipant.storeParticipantsAndCalcWidths(a.fromParticipantName,a.toParticipantName,a.totalWidth);else{var b=a.totalWidth/2;SEQ.entityParticipant.storeParticipantWithDefinedWidths(a.fromParticipantName,b,b)}}function e(){for(var a=g(),b=SEQ.parser.diagram.fragments,c=0;c<b.length;c++){for(var e=b[c],h=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,j=null,k=null,l=0;l<e.enclosedEntitiesData.length;l++){var m=e.enclosedEntitiesData[l],n=a[m.participantName];n<h&&(h=n,j=m),n>i&&(i=n,k=m)}if(!j){var o=SEQ.parser.diagram.participants[0];j={participantName:o.name,entityLeftWidth:o.entityLeftWidth,entityRightWidth:o.entityRightWidth,timelineLeftWidth:o.timelineLeftWidth,timelineRightWidth:o.timelineRightWidth}}if(!k){var p=SEQ.parser.diagram.participants[SEQ.parser.diagram.participants.length-1];k={participantName:p.name,entityLeftWidth:p.entityLeftWidth,entityRightWidth:p.entityRightWidth,timelineLeftWidth:o.timelineLeftWidth,timelineRightWidth:o.timelineRightWidth}}if(e.participantDataMin=j,e.participantDataMax=k,e.type===SEQ.entityFragment.Type.EXPANDABLE_PLUS){var q=e.startEntry.textData.width,r=SEQ.metrics.calcWidth(e.type,e.font);r>q&&(q=r),j.participantName!=k.participantName?(e.startEntry.totalWidth=q+2*SEQ.metrics.data.textPadding,e.startEntry.fromParticipantName=j.participantName,e.startEntry.toParticipantName=k.participantName):(e.startEntry.totalWidth=q+2*SEQ.metrics.data.textPadding+2*SEQ.metrics.data.boxBleed+2*SEQ.metrics.data.entryMarginSide,e.startEntry.fromParticipantName=j.participantName),d(e.startEntry)}var s=f(e.subFragments,j,k),t=SEQ.metrics.data.fragmentBleed,u=Math.max(t,j.entityLeftWidth);s.leftWidth>u&&(u=s.leftWidth);var v=Math.max(t,k.entityRightWidth);s.rightWidth>v&&(v=s.rightWidth),e.leftWidth=u,e.rightWidth=v;var w=SEQ.parser.diagram.participantsByName[j.participantName],x=SEQ.parser.diagram.participantsByName[k.participantName];SEQ.entityParticipant.updateParticipantRequiredEntityWidth(w,u+SEQ.metrics.data.fragmentMarginSide,0),SEQ.entityParticipant.updateParticipantRequiredEntityWidth(x,0,v+SEQ.metrics.data.fragmentMarginSide)}}function f(a,b,c){for(var d=0,e=0,f=0;f<a.length;f++){var g,h,i=a[f];i.type===SEQ.entityFragment.Type.EXPANDABLE_PLUS?i.startEntry.toParticipantName?(g=0,h=0):(g=i.startEntry.totalWidth/2,h=i.startEntry.totalWidth/2):(g=i.leftWidth,h=i.rightWidth),i.participantDataMin.participantName==b.participantName&&g>d&&(d=g),i.participantDataMax.participantName==c.participantName&&h>e&&(e=h)}return{leftWidth:d+SEQ.metrics.data.fragmentMarginSide,rightWidth:e+SEQ.metrics.data.fragmentMarginSide}}function g(){for(var a=SEQ.parser.diagram.participants,b=[],c=0;c<a.length;c++)b[a[c].name]=c;return b}function h(a,b){return a+2*SEQ.metrics.data.fragmentLabelSidePadding+b+SEQ.metrics.data.fragmentLabelEdgeLength}function i(a){var b=SEQ.parser.diagram.participantsByName[a.fromParticipantName].posX,c=null;return a.toParticipantName&&(c=SEQ.parser.diagram.participantsByName[a.toParticipantName].posX),{fromX:b,toX:c}}function j(a,b,c){var d,e,f,g,h=i(a),j=h.fromX,k=h.toX,m=SEQ.metrics.data.boxBleed;if(k){var n=k>j?j:k;d=n-m,g=Math.abs(j-k)+2*m,e=d+g/2-a.textData.width/2,f=a.posY-a.totalHeight/2-a.textData.height/2}else d=j-a.totalWidth/2+SEQ.metrics.data.entryMarginSide,g=a.totalWidth-2*SEQ.metrics.data.entryMarginSide,e=j-a.textData.width/2,f=a.posY-a.totalHeight/2-a.textData.height/2;b.save(),b.lineWidth=SEQ.metrics.data.fragmentLineWeight,b.font="bold "+SEQ.main.getFontSmall(),l(b,b.font,d,a.posY-a.totalHeight,SEQ.metrics.data.fragmentHeight,a.posY-SEQ.metrics.data.fragmentHeight,a.topMargin,d+g,a.type,!0),b.restore(),f+=SEQ.metrics.data.fragmentHeight/2,SEQ.textUtil.fillText(b,c,a.textData.parsedLines,e,f)}function k(a,b,c,d){function e(a){if(b.save(),b.setLineDash([SEQ.metrics.data.fragmentElseLineDashWidth]),b.beginPath(),b.moveTo(i,a.posY-a.totalHeight),b.lineTo(j,a.posY-a.totalHeight),b.stroke(),b.restore(),a.text){var c=h(i,SEQ.metrics.calcWidth(f.type));b.fillText("["+a.text+"]",c+SEQ.metrics.data.fragmentTextSideMargin,a.posY-SEQ.metrics.data.fragmentTextPosYOffset)}}var f=a.fragment;if(a.type!=z.END&&f.endPosY||c||d){var g=r(f),i=g.minX,j=g.maxX,k=f.posY-f.totalHeight;if(b.save(),b.lineWidth=SEQ.metrics.data.fragmentLineWeight,b.font=f.font,z.ELSE==a.type)(c||d)&&e(a.elseGuard);else{var m=f.type;f.groupLabel&&(m=f.groupLabel),l(b,f.font,i,k,f.totalHeight,f.endPosY,f.topMargin,j,m,!1,f.text),f.elseGuards.forEach(function(a){e(a)})}b.restore()}}function l(a,b,c,d,e,f,g,i,j,k,l){var m=SEQ.metrics.calcWidth(j,b),n=h(c,m),o=a.fillStyle;a.fillStyle="white",a.beginPath(),a.rect(c,d,i-c,f-d+g),k&&a.fill(),a.stroke(),a.beginPath(),a.moveTo(c,d),a.lineTo(c,d+e),a.lineTo(c+2*SEQ.metrics.data.fragmentLabelSidePadding+m,d+e),a.lineTo(n,d+SEQ.metrics.data.fragmentLabelSmallHeight),a.lineTo(n,d),a.lineTo(c,d),a.fill(),a.stroke(),a.fillStyle=o,a.fillText(j,c+SEQ.metrics.data.fragmentLabelSidePadding,d+e-SEQ.metrics.data.fragmentTextPosYOffset),l&&a.fillText("["+l+"]",n+SEQ.metrics.data.fragmentTextSideMargin,d+e-SEQ.metrics.data.fragmentTextPosYOffset)}function m(a){for(var b=SEQ.parser.diagram.fragments,c=0;c<b.length;c++){var d=b[c];if(z.ALT==d.type){var e=r(d);if(a.y>d.posY-d.totalHeight&&a.y<d.endPosY+d.topMargin&&a.x>e.minX&&a.x<e.maxX)return!0}}}function n(a){return a.indexOf("expandable")>-1}function o(a,b,c){if(n(a.type)&&u(a,b,c,!1))return A.TOGGLE;var d=a.fragment;if(!d.participantDataMin||!d.participantDataMax)return{main:{startX:0,endX:0,startY:0,endY:0}};var e=r(d);return a.type===z.END?{main:{startX:e.minX,endX:e.maxX,startY:a.posY+SEQ.metrics.data.collisionBleed/2,endY:a.posY-SEQ.metrics.data.collisionBleed/2}}:{main:{startX:e.minX,endX:e.maxX,startY:a.posY,endY:a.posY-a.totalHeight}}}function p(){var a=this.collision(this).main,b=[];if(n(this.type)){var c=t(this,!1);b.push({minX:c.startX,maxX:c.endX,minY:c.endY,maxY:c.startY,type:"zoom-out"},{minX:c.endX,maxX:a.endX,minY:a.endY,maxY:a.startY,type:"pointer"})}else{var d;d=this.type===z.END?"ns-resize":"pointer",b.push({minX:a.startX,maxX:a.endX,minY:a.endY,maxY:a.startY,type:d})}return b}function q(){var a=this.collision(this).main,b=t(this,!0),c=[];return c.push({minX:b.startX,maxX:b.endX,minY:b.endY,maxY:b.startY,type:"zoom-in"},{minX:a.startX,maxX:b.endX,minY:b.startY,maxY:a.startY,type:"pointer"},{minX:b.endX,maxX:a.endX,minY:a.endY,maxY:a.startY,type:"pointer"}),c}function r(a){var b=SEQ.parser.diagram.participantsByName,c=b[a.participantDataMin.participantName],d=c.posX-a.leftWidth-a.participantDataMin.timelineLeftWidth,e=b[a.participantDataMax.participantName],f=e.posX+a.rightWidth+a.participantDataMax.timelineRightWidth;return{minX:d,maxX:f}}function s(a,b,c){if(n(a.type)&&u(a,b,c,!0))return A.TOGGLE;var d,e,f=i(a),g=f.fromX,h=f.toX;return h?(g<h?(d=g,e=h):(d=h,e=g),d-=SEQ.metrics.data.boxBleed,e+=SEQ.metrics.data.boxBleed):(d=g-a.totalWidth/2+SEQ.metrics.data.entryMarginSide,e=g+a.totalWidth/2-SEQ.metrics.data.entryMarginSide),{main:{startX:d,endX:e,startY:a.posY,endY:a.posY-a.totalHeight}}}function t(a,b){var c,d=a.fragment,e=SEQ.metrics.calcWidth(d.type,d.font);if(b){var f=i(a),g=f.fromX,j=f.toX;if(j){var k=j>g?g:j;c=k-SEQ.metrics.data.boxBleed}else c=g-a.totalWidth/2+SEQ.metrics.data.entryMarginSide}else c=r(d).minX;var l=h(c,e),m=d.posY-d.totalHeight;return{startX:c,endX:l,startY:m+SEQ.metrics.data.fragmentHeight,endY:m}}function u(a,b,c,d){var e=t(a,d);if(c<e.startY&&c>e.endY&&b>e.startX&&b<e.endX)return!0}function v(a,b){var c=a+" "+b;return z.ELSE!=a&&(c+="\nend"),c}function w(a){return null!=x.exec(a)||a===z.GROUP}var x=new RegExp("^\\s*(alt|else|opt|loop|par|break|critical|seq|strict|neg|ignore|consider|assert|region|end|expandable\\-|expandable\\âˆ’|expandable\\+)(?:$|\\s(.*))|\\s*(group)\\s*([^\\[]+)(?:(\\[)(.*)(\\]))?"),y={OPERATOR:1,TEXT:2,GROUP:3,GROUP_LABEL:4,GROUP_CONDITION_LEFT_BRACKET:5,GROUP_CONDITION:6,GROUP_CONDITION_RIGHT_BRACKET:7},z={ALT:"alt",ELSE:"else",OPT:"opt",LOOP:"loop",PAR:"par",BREAK:"break",CRITICAL:"critical",EXPANDABLE_DASH:"expandable-",EXPANDABLE_MINUS:"expandableâˆ’",EXPANDABLE_PLUS:"expandable+",SEQ:"seq",STRICT:"strict",NEG:"neg",IGNORE:"ignore",CONSIDER:"consider",ASSERT:"assert",END:"end",GROUP:"group"},A={TOGGLE:"toggle"};return{parse:a,paint:k,regExp:x,build:v,storeEnclosedEntriesData:c,updateParticipantWidths:e,populateEnclosingCollapsedFragment:b,collision:o,insideAlt:m,paintFragment:l,isType:w,Type:z,CollisionType:A,groups:y}}();var SEQ=SEQ||{};SEQ.entityEntrySpacing=function(){function a(a){var b=c.exec(a);if(null!=b&&b.length>d.SPACING){var e=b[d.SPACING];return{raw:a,entrySpacing:parseFloat(e)}}}function b(a){return a<0&&(a=0),"entryspacing "+a.toFixed(1)}var c=new RegExp("^\\s*(entryspacing)\\s?([0-9]+(?:\\.[0-9]+)?$)"),d={ENTRY_SPACING:1,SPACING:2},e={ENTRY_SPACING:"entryspacing"};return{parse:a,build:b,regExp:c,groups:d,Type:e}}();var SEQ=SEQ||{};SEQ.entityParticipantSpacing=function(){function a(a){var b=c.exec(a);if(null!=b&&b.length>d.SPACING){var e=b[d.SPACING];return{raw:a,participantSpacing:e}}}var b="equal",c=new RegExp("^\\s*(participantspacing)\\s?([0-9]+(?:\\.[0-9]+)?|"+b+")$"),d={PARTICIPANT_SPACING:1,SPACING:2},e={PARTICIPANT_SPACING:"participantspacing"};return{parse:a,equal:b,regExp:c,groups:d,Type:e}}();var SEQ=SEQ||{};SEQ.entityFontSize=function(){function a(a){var d=b.exec(a);if(null!=d&&d.length>c.SIZE){var e=d[c.SIZE];return{raw:a,fontSize:e}}}var b=new RegExp("^\\s*(fontsize)\\s?([0-9]+)"),c={FONT_SIZE:1,SIZE:2},d={FONT_SIZE:"fontsize"};return{parse:a,regExp:b,groups:c,Type:d}}();var SEQ=SEQ||{};SEQ.entityParallel=function(){function a(a){var d=b.exec(a);if(null!=d&&d.length>c.STATUS){var e=d[c.STATUS];if("on"===e)var f=!0;else f="off"!==e&&"end"!==e;return{raw:a,enabled:f}}}var b=new RegExp("^\\s*(parallel)\\s?(on|off|end)?"),c={PARALLEL:1,STATUS:2},d={PARALLEL:"parallel"};return{parse:a,regExp:b,groups:c,Type:d}}();var SEQ=SEQ||{};SEQ.entityActivation=function(){function a(a){var c=g.exec(a);if(null!=c&&c.length>h.PARTICIPANT){var f=c[h.TYPE],j=c[h.PARTICIPANT],k=c[h.COLOR_NAME],l=c[h.COLOR_HEX],m=k?k:l,n=SEQ.parser.diagram.ongoingActivations[j];if(f.indexOf(i.DEACTIVATE)>-1){if(n&&n.length){var o=n.pop();return o.endPosY=SEQ.parser.diagram.entries[SEQ.parser.diagram.entries.length-1].posY,i.DEACTIVATE_AFTER===f&&(o.endPosY+=SEQ.metrics.data.activationAfterHeight),{raw:a}}}else if(f.indexOf(i.ACTIVATE)>-1){n||(SEQ.parser.diagram.ongoingActivations[j]=[],n=SEQ.parser.diagram.ongoingActivations[j]);var p={type:f,fromParticipantName:j,centerDiff:d(j),totalHeight:0,totalWidth:0,topMargin:0,color:m,activation:!0,raw:a,paint:b};if(n.push(p),SEQ.entityParticipant.storeParticipantWithTimelineWidths(j,SEQ.metrics.data.activationSideWidth,e(n)+SEQ.metrics.data.activationSideWidth),!p.color){var q=SEQ.parser.diagram.participantsByName[j];p.color=q.activeColor?q.activeColor:SEQ.parser.diagram.participantActiveColor}return p}}}function b(a,b){var c,d=SEQ.parser.diagram.participantsByName,e=d[a.fromParticipantName].posX+a.centerDiff;c=a.endPosY?a.endPosY:SEQ.parser.diagram.entries[SEQ.parser.diagram.entries.length-1].posY+SEQ.metrics.data.diagramMarginBottom-SEQ.metrics.data.baseSpaceMetric;var f=SEQ.metrics.data.activationSideWidth,g=a.posY;b.beginPath(),b.moveTo(e-f,g),b.lineTo(e+f,g),b.lineTo(e+f,c),b.lineTo(e-f,c),b.lineTo(e-f,g);var h=b.fillStyle;a.color?b.fillStyle=a.color:b.fillStyle="white",b.fill(),b.stroke(),b.fillStyle=h}function c(a,b){return a+" "+b}function d(a){var b=SEQ.parser.diagram.ongoingActivations[a];return b?0===b.length?0:b.length>=1?b.length*SEQ.metrics.data.activationSideWidth:void 0:0}function e(a){return a.length<=1?0:(a.length-1)*SEQ.metrics.data.activationSideWidth}function f(a){return i.ACTIVATE===a||i.DEACTIVATE===a||i.DEACTIVATE_AFTER===a}var g=new RegExp("^\\s*(activate|deactivate|deactivateafter)\\s"+SEQ.entityParticipant.nameGroup+"\\s?"+SEQ.entityParticipant.colorGroup),h={TYPE:1,PARTICIPANT:2,COLOR_NAME:3,COLOR_HEX:4},i={ACTIVATE:"activate",DEACTIVATE:"deactivate",DEACTIVATE_AFTER:"deactivateafter"};return{parse:a,paint:b,build:c,calcActivationCenterDiff:e,isType:f,Type:i,regExp:g,groups:h}}();var SEQ=SEQ||{};SEQ.entitySpace=function(){function a(a){var f=h.exec(a);if(null!=f&&f.length>=i.VALUE){var g=f[i.VALUE];return g||(g=1),{type:j.SPACE,totalHeight:SEQ.metrics.data.textLineHeight*g,topMargin:SEQ.metrics.data.entityMarginTop,paint:c,collision:d,collisionTypeAreas:e,updatePos:b,raw:a}}}function b(a,b){a.posY=b}function c(a,b,c,e){if(c||e){var f=d(a).main;b.beginPath(),b.moveTo(f.startX,f.endY),b.lineTo(f.endX,f.endY),b.lineTo(f.endX,f.startY),b.lineTo(f.startX,f.startY),b.lineTo(f.startX,f.endY),b.stroke()}}function d(a){var b=SEQ.parser.diagram.participants,c=b[b.length-1],d=SEQ.metrics.data.entryMarginSide,e=c.width>c.entityRightWidth-SEQ.metrics.data.entryMarginSide?c.width/2:c.entityRightWidth-SEQ.metrics.data.entryMarginSide,f=c.posX+c.timelineRightWidth+e;
return{main:{startX:d,endX:f,startY:a.posY,endY:a.posY-a.totalHeight}}}function e(){var a=this.collision(this).main,b=[];return b.push({minX:a.startX,maxX:a.endX,minY:a.endY,maxY:a.startY,type:"ns-resize"}),b}function f(a){return a}function g(a){return j.SPACE===a}var h=new RegExp("^\\s*(space)\\s?([0-9]+(?:\\.[0-9]+)?)?$"),i={SPACE:1,VALUE:2},j={SPACE:"space"};return{parse:a,build:f,isType:g,Type:j,regExp:h,groups:i}}();var SEQ=SEQ||{};SEQ.entityCreateDestroy=function(){function a(a,f,m){var q=n.exec(a);if(null!=q&&q.length>o.PARTICIPANT){var r=q[o.TYPE],s=q[o.PARTICIPANT];if(r===p.CREATE){var t=SEQ.parser.diagram.participantsByName[s];return t||(SEQ.entityParticipant.storeParticipantWithDefinedWidths(s,0,0),t=SEQ.parser.diagram.participantsByName[s]),t.createPosY.push(f+m+SEQ.metrics.data.entityMarginTop+t.height),{type:p.CREATE,fromParticipantName:s,participantToCreate:t,totalHeight:t.height,totalWidth:t.width,topMargin:SEQ.metrics.data.entityMarginTop,lockedPosX:!0,updateEnclosingFragments:b,paint:g,updatePos:c,collision:i,collisionTypeAreas:k,raw:a}}if(r===p.DESTROY||r===p.DESTROY_SILENT){var u=SEQ.parser.diagram.participantsByName[s];return u||(u=SEQ.entityParticipant.storeParticipantWithDefinedWidths(s,0,0)),u.destroyPosY.push(f+m),{type:r,fromParticipantName:s,participantToDestroy:u,totalHeight:0,totalWidth:SEQ.metrics.data.participantDestroySize,topMargin:0,lockedPosX:!0,paint:h,updatePos:c,collision:j,collisionTypeAreas:l,updateEnclosingFragments:e,updateParticipantWidths:d,raw:a}}if(r===p.DESTROY_AFTER){var v=SEQ.parser.diagram.participantsByName[s];if(v){var w=SEQ.metrics.data.participantDestroySize;return v.destroyPosY.push(f+m+w/2+SEQ.metrics.data.entityMarginTop),{type:r,fromParticipantName:s,participantToDestroy:v,totalHeight:w,totalWidth:SEQ.metrics.data.participantDestroySize,topMargin:SEQ.metrics.data.entityMarginTop,lockedPosX:!0,paint:h,updatePos:c,collision:j,collisionTypeAreas:l,updateEnclosingFragments:e,updateParticipantWidths:d,raw:a}}}}}function b(a){var b=a.totalWidth/2+SEQ.metrics.data.entryMarginSide;SEQ.entityFragment.storeEnclosedEntriesData(a.fromParticipantName,b,b,0,0)}function c(a,b,c){a.posY=b,a.fromPosX=c}function d(a){var b=a.totalWidth/2;SEQ.entityParticipant.storeParticipantWithDefinedWidths(a.fromParticipantName,b,b)}function e(a){var b=a.totalWidth/2;SEQ.entityFragment.storeEnclosedEntriesData(a.fromParticipantName,b,b,0,0)}function f(a){return{fromPosX:SEQ.parser.diagram.participantsByName[a.fromParticipantName].posX}}function g(a,b){SEQ.entityParticipant.paintParticipant(a.participantToCreate,b,a.posY-SEQ.parser.diagram.participantMaxHeight)}function h(a,b){if(a.type.indexOf("silent")===-1){var c=f(a).fromPosX,d=a.posY;a.type===p.DESTROY_AFTER&&(d-=SEQ.metrics.data.participantDestroySize/2),b.save(),b.lineWidth=SEQ.metrics.data.participantDestroyLineWeight,b.beginPath();var e=SEQ.metrics.data.participantDestroySize/2;b.moveTo(c-e,d-e),b.lineTo(c+e,d+e),b.moveTo(c+e,d-e),b.lineTo(c-e,d+e),b.stroke(),b.restore()}}function i(a){var b=f(a).fromPosX;return{participantToCreate:{startX:b-a.participantToCreate.width/2,endX:b+a.participantToCreate.width/2,startY:a.posY,endY:a.posY-a.totalHeight}}}function j(a){var b,c,d=f(a).fromPosX,e=SEQ.metrics.data.participantDestroySize/2;return a.type===p.DESTROY_AFTER?(b=a.posY,c=a.posY-SEQ.metrics.data.participantDestroySize):(b=a.posY+e,c=a.posY-e),{main:{startX:d-a.totalWidth/2,endX:d+a.totalWidth/2,startY:b,endY:c}}}function k(){var a=this.collision(this).participantToCreate,b=[];return b.push({minX:a.startX,maxX:a.endX,minY:a.endY,maxY:a.startY,type:"pointer"}),b}function l(){var a=this.collision(this).main,b=[];return b.push({minX:a.startX,maxX:a.endX,minY:a.endY,maxY:a.startY,type:"pointer"}),b}function m(a){var b=n.exec(a);if(null!=b&&b.length>o.PARTICIPANT&&b[o.TYPE]===p.CREATE)return b[o.PARTICIPANT]}var n=new RegExp("^\\s*(create|destroy|destroyafter|destroysilent)\\s"+SEQ.entityParticipant.nameGroup),o={TYPE:1,PARTICIPANT:2},p={CREATE:"create",DESTROY:"destroy",DESTROY_AFTER:"destroyafter",DESTROY_SILENT:"destroysilent"};return{parse:a,paint:h,createdParticipant:m,Type:p,regExp:n,groups:o}}();var SEQ=SEQ||{};SEQ.entityActiveColor=function(){function a(a){var d=b.exec(a);if(null!=d&&d.length>c.COLOR_NAME){var e=d[c.PARTICIPANT],f=d[c.COLOR_NAME],g=d[c.COLOR_HEX],h=f?f:g;if(e){var i=SEQ.parser.diagram.participantsByName[e];return i||(i=SEQ.entityParticipant.storeParticipantWithDefinedWidths(e,0,0)),i.activeColor=h,{raw:a}}return SEQ.parser.diagram.participantActiveColor=h,{raw:a}}}var b=new RegExp("^\\s*(activecolor)\\s"+SEQ.entityParticipant.nameGroup+"?\\s?"+SEQ.entityParticipant.colorGroupMandatory),c={ACTIVE_COLOR:1,PARTICIPANT:2,COLOR_NAME:3,COLOR_HEX:4},d={ACTIVE_COLOR:"activecolor"};return{parse:a,regExp:b,groups:c,Type:d}}();var SEQ=SEQ||{};SEQ.entityLifeLineColor=function(){function a(a){var d=b.exec(a);if(null!=d&&d.length>c.COLOR_NAME){var e=d[c.PARTICIPANT],f=d[c.COLOR_NAME],g=d[c.COLOR_HEX],h=f?f:g;if(e){var i=SEQ.parser.diagram.participantsByName[e];return i||(i=SEQ.entityParticipant.storeParticipantWithDefinedWidths(e,0,0)),i.lifeLineColor=h,{raw:a}}return SEQ.parser.diagram.participantLifeLineColor=h,{raw:a}}}var b=new RegExp("^\\s*(lifelinecolor)\\s"+SEQ.entityParticipant.nameGroup+"?\\s?"+SEQ.entityParticipant.colorGroupMandatory),c={LIFE_LINE_COLOR:1,PARTICIPANT:2,COLOR_NAME:3,COLOR_HEX:4},d={LIFE_LINE_COLOR:"lifelinecolor"};return{parse:a,regExp:b,groups:c,Type:d}}();var SEQ=SEQ||{};SEQ.entityLifeLineWeight=function(){function a(a){var d=b.exec(a);if(null!=d&&d.length>c.VALUE)return SEQ.parser.diagram.participantLifeLineWeight=d[c.VALUE],{raw:a}}var b=new RegExp("^\\s*(lifelineweight)\\s?([0-9]+(?:\\.[0-9]+)?)$"),c={LIFE_LINE_WEIGHT:1,VALUE:2},d={LIFE_LINE_WEIGHT:"lifelineweight"};return{parse:a,regExp:b,groups:c,Type:d}}();var SEQ=SEQ||{};SEQ.painter=function(){function a(){var a=SEQ.parser.diagram,g=f();e(g);var h=SEQ.main.getDiagramContext();h.save(),h.fillStyle="white";var i=SEQ.main.getDiagramCanvas();if(h.fillRect(0,0,i.width,i.height),h.restore(),a.title&&(h.save(),SEQ.entityTitle.paint(g),h.restore()),a.participants.length>0){h.save(),d(g,h),h.restore(),h.save(),b(),h.restore(),h.save(),c(),h.restore();var j=SEQ.main.getParticipantContext();a.participants.forEach(function(a){SEQ.entityParticipant.paint(a,j,!0)})}}function b(){var a=SEQ.parser.diagram,b=SEQ.main.getDiagramContext();a.participants.forEach(function(a){SEQ.entityParticipant.paint(a,b)})}function c(){var a=SEQ.parser.diagram,b=SEQ.main.getDiagramContext(),c=[],d=[],e=[];a.entries.forEach(function(a){a.paint&&!a.enclosingCollapsedFragment&&(a.fragment?e.push(a):a.activation?c.push(a):d.push(a))}),c.forEach(function(a){a.paint(a,b)}),d.forEach(function(a){a.paint(a,b)}),e.forEach(function(a){a.paint(a,b)})}function d(a,b,c){var d=SEQ.parser.diagram,e=SEQ.metrics.data;d.participantLifeLineWeight?b.lineWidth=d.participantLifeLineWeight:b.lineWidth=SEQ.metrics.data.diagramLifeLineWeight,d.participants.forEach(function(f){void 0!==b.setLineDash&&b.setLineDash([SEQ.metrics.data.diagramLifeLineDashSize,SEQ.metrics.data.diagramLifeLineSpaceSize]),f.lifeLineColor?b.strokeStyle=f.lifeLineColor:d.participantLifeLineColor?b.strokeStyle=d.participantLifeLineColor:b.strokeStyle="black";var g,h,i=f.destroyPosY.slice();f.createPosY.length?f.createPosY.forEach(function(c){g=c,h=i.length?i.shift():a.height,b.beginPath(),b.moveTo(f.posX,g),b.lineTo(f.posX,h),b.stroke()}):(g=e.participantMarginTop+d.participantMaxHeight,d.title&&!c&&(g+=SEQ.parser.diagram.title.totalHeight),h=f.destroyPosY.length?f.destroyPosY.pop():a.height,b.beginPath(),b.moveTo(f.posX,g),b.lineTo(f.posX,h),b.stroke())})}function e(a){var b=a.width,c=a.height,d=a.heightParticipant,e=SEQ.main.getDiagramCanvas(),f=SEQ.main.getInteractionCanvas(),g=SEQ.main.getParticipantCanvas();e.width=b,e.height=c,f.width=b,f.height=c,g.width=b,g.height=d;var h=SEQ.main.getDiagramContext();h.font=SEQ.main.getFontNormal(),h.lineWidth=SEQ.metrics.data.diagramLineWeight,h.fillStyle="black",h.strokeStyle="black";var i=SEQ.main.getInteractionContext();i.font=SEQ.main.getFontNormal(),i.lineWidth=SEQ.metrics.data.diagramLineWeight;var j=SEQ.main.getParticipantContext();j.font=SEQ.main.getFontNormal(),j.lineWidth=SEQ.metrics.data.diagramLineWeight,j.fillStyle="black",j.strokeStyle="black"}function f(){var a={width:0,height:0,heightParticipant:0},b=SEQ.parser.diagram;if(b.participants.length>0){var c=b.entries[b.entries.length-1].posY;0===c&&(c=SEQ.parser.diagram.participantMaxHeight+SEQ.metrics.data.participantMarginTop),a.height=c+SEQ.metrics.data.diagramMarginBottom;var d=b.participants[b.participants.length-1],e=Math.max(d.width/2+SEQ.metrics.data.participantMarginSide,d.entityRightWidth+d.timelineRightWidth);a.width=d.posX+e,a.heightParticipant=SEQ.parser.diagram.participantMaxHeight+SEQ.metrics.data.participantMarginTop+SEQ.metrics.data.participantBoxLineWeight}else b.title&&(a.height=b.title.totalHeight,a.width=SEQ.metrics.calcWidth(b.title.title,SEQ.main.getFontTitle())+2*SEQ.metrics.data.textPadding);return a}return{paint:a}}();var SEQ=SEQ||{};SEQ.interactor=function(){function a(a){E=a}function b(a){var b=SEQ.main.getInteractionCanvas(),c=b.getBoundingClientRect(),d=a.clientX-c.left,e=a.clientY-c.top;return{x:d,y:e}}function c(a,b){var c=500,d=200,e=a.pageY,f=a.pageX-c/2;H=document.createElement("div"),H.style.position="absolute",H.style.top=e+"px",H.style.left=f+"px",H.style.zIndex=100;var g=document.createElement("img");g.setAttribute("src","assets/closeicon.png"),g.setAttribute("onclick","SEQ.interactor.cancelAllInteraction()"),g.style.position="relative",g.style.top="-13px",g.style.left="-13px",g.style.width="25px",g.style.height="25px",g.style.zIndex=200,H.appendChild(g);var i=document.createElement("textarea");i.id="editEntryTextArea",i.style.position="absolute",i.style.top="0px",i.style.left="0px",i.style.zIndex=101,i.style.width=c+"px",i.style.height=d+"px",i.style.padding="7px",i.onkeydown=h,H.appendChild(i),document.body.appendChild(H),b?i.value=b.replace(/\\n/g,"\n"):i.value="info",i.setSelectionRange(0,i.value.length),i.focus()}function d(a,b){var c=new RegExp("^"+SEQ.entityParticipant.nameGroup+"$");if(c.exec(b)){for(var d=SEQ.parser.diagram.entries,e="",g=0;g<d.length;g++){var h,i=d[g],j=a.name.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),k=new RegExp("(^|[^\\w\\d])"+j+"([^\\w\\d]|$)","g");h=i.raw?i.raw.replace(k,"$1"+b+"$2"):i.raw,e+=g===d.length-1?h:h+"\n"}SEQ.main.updateSource(e)}f(),SEQ.parser.parse()}function e(){H&&document.body.removeChild(H),H=null,E=null,F=null,G=null,w()}function f(){SEQ.contextMenu.cancel(),SEQ.messageCreator.cancel(),SEQ.entryMover.cancel(),e()}function g(){F=null,G=null,w()}function h(a){a.shiftKey||13!=a.keyCode||(a.preventDefault(),i())}function i(){var a=H.getElementsByTagName("textarea")[0].value;if(document.body.removeChild(H),H=null,F){var b=F.raw;if(F.type==SEQ.entityParticipant.Type.PARTICIPANT)d(F,a);else if(G)d(G,a);else if(SEQ.entityFragment.regExp.exec(F.type)){var c=b.indexOf(" ");c>-1?F.raw=b.substring(0,b.indexOf(" ")+1)+a.replace(/\n/g,"\\n"):F.raw=b+" "+a.replace(/\n/g,"\\n"),n()}else SEQ.entityDivider.Type.DIVIDER===F.type?(F.raw=SEQ.entityDivider.build(a.replace(/\n/g,"\\n")),n()):(F.raw=b.substring(0,b.indexOf(":")+1)+a.replace(/\n/g,"\\n"),n())}else E&&(E.text=a,o(E))}function j(a){if(!SEQ.parser.parsingState.ongoing){var b=a.target.tagName;27==a.keyCode&&f(),D()||(46==a.keyCode?F&&l(a,F):187==a.keyCode||171==a.keyCode||107==a.keyCode?"TEXTAREA"!=b&&"INPUT"!=b&&k(.1):189==a.keyCode||173==a.keyCode||109==a.keyCode?"TEXTAREA"!=b&&"INPUT"!=b&&k(-.1):90==a.keyCode&&a.ctrlKey&&a.shiftKey?(a.preventDefault(),SEQ.main.redoChange()):90==a.keyCode&&a.ctrlKey?(a.preventDefault(),SEQ.main.undoChange()):89==a.keyCode&&a.ctrlKey&&(a.preventDefault(),SEQ.main.redoChange()))}}function k(a){for(var b=!1,c=SEQ.parser.diagram.entries,d="",e=0;e<c.length;e++){var f=c[e];null!=f.entrySpacing&&(b=!0,f.raw=SEQ.entityEntrySpacing.build(f.entrySpacing+a)),!b&&f.type&&f.type!=SEQ.entityParticipant.Type.PARTICIPANT&&f.type!=SEQ.entityTitle.Type.TITLE&&(d+=SEQ.entityEntrySpacing.build(SEQ.metrics.constants.entrySpacingRatio+a)+"\n",b=!0),d=A(e,c,d,f.raw)}SEQ.main.updateSource(d),SEQ.parser.parse()}function l(a,b){if(!H){a.preventDefault();var c,d=SEQ.parser.diagram.entries;c=SEQ.entityParticipant.isType(b.type)?function(a,b){return a.name===b.fromParticipantName||a.name===b.toParticipantName}:SEQ.entityFragment.isType(b.type)&&SEQ.entityFragment.Type.ELSE!=b.type?b.fragment.type===SEQ.entityFragment.Type.EXPANDABLE_PLUS?function(a,b){return a.fragment==b.fragment||a.fragment==b.enclosingCollapsedFragment}:function(a,b){return a.fragment==b.fragment}:function(a,b){return a===b};for(var e="",f=0;f<d.length;f++){var g=d[f];c(b,g)||(e=A(f,d,e,g.raw))}SEQ.main.updateSource(e),SEQ.parser.parse()}}function m(){var a=SEQ.parser.diagram.entries,b=!1,c="";I++;for(var d="participant ChangeMe"+I,e=0;e<a.length;e++){var f=a[e];SEQ.entityTitle.isType(f.type)||SEQ.entityParticipant.isType(f.type)||b||(c+=d+"\n",b=!0),c=A(e,a,c,f.raw)}b||(c+="\n"+d),SEQ.main.updateSource(c),SEQ.parser.parse()}function n(){for(var a=SEQ.parser.diagram.entries,b="",c=0;c<a.length;c++){var d=a[c];b=A(c,a,b,d.raw)}SEQ.main.updateSource(b),SEQ.parser.parse()}function o(a){function b(){return SEQ.entityMessage.regExpArrow.exec(a.type)?SEQ.entityMessage.build(a.type,a.fromParticipantName,a.toParticipantName,a.text):SEQ.entityNoteBoxLeftRight.isType(a.type)?a.notePosition===SEQ.entityNoteBoxOver.NotePosition.OVER?SEQ.entityNoteBoxOver.build(a.type,a.participants,a.text):SEQ.entityNoteBoxLeftRight.build(a.type,a.notePosition,a.participants,a.text):SEQ.entityDivider.isType(a.type)?SEQ.entityDivider.build(a.text):SEQ.entityFragment.isType(a.type)?SEQ.entityFragment.build(a.type,a.text):SEQ.entityActivation.isType(a.type)?SEQ.entityActivation.build(a.type,a.participants):SEQ.entitySpace.isType(a.type)?SEQ.entitySpace.build(a.type):void 0}for(var c=SEQ.parser.diagram.entries,d=!1,e="",f=0;f<c.length;f++){var g=c[f];!d&&g.type&&a.posY<g.posY&&(e+=b()+"\n",d=!0),e=A(f,c,e,g.raw)}d||(e+="\n"+b()),a=null,SEQ.main.updateSource(e),SEQ.parser.parse()}function p(a){H||K||(SEQ.messageCreator.finishMessage(a),SEQ.entryMover.finishMove(a)),y(a)}function q(a){function c(a){return a.buttons?1!=a.buttons:!!a.which&&1!=a.which}if(D()&&i(),K=c(a),!H&&!K){SEQ.main.blurEditor();var d=(new Date).getTime();if(d-J<400){var e,f=b(a),g=SEQ.parser.diagram.title?SEQ.parser.diagram.title.totalHeight:0,h=g+SEQ.metrics.data.participantMarginTop;e=f.y>h&&f.y<h+SEQ.parser.diagram.participantMaxHeight?SEQ.entityParticipant.findParticipantXCollision(f.x,f.y,!1):u(f.x,f.y),F==e?s(a):(J=d,r(a))}else J=d,r(a);a.preventDefault()}}function r(a){f();var c=SEQ.main.getInteractionContext();c.save(),c.fillStyle="#ff0000",c.strokeStyle="#ff0000";var d=b(a),e=SEQ.parser.diagram.title?SEQ.parser.diagram.title.totalHeight:0,g=e+SEQ.metrics.data.participantMarginTop;if(d.y>g&&d.y<g+SEQ.parser.diagram.participantMaxHeight){var h=SEQ.entityParticipant.findParticipantXCollision(d.x,d.y,!1);h&&(F=h,SEQ.entityParticipant.paint(h,c,!1,!0),F.entry&&t(F.entry))}else{var i=u(d.x,d.y);if(i)i.paint(i,c,!0),t(i),F=i,i.updatePos&&SEQ.entryMover.startMove(a,i);else{var j=SEQ.entityParticipant.findParticipantXCollision(d.x,d.y,!0);j&&SEQ.messageCreator.startMessage(a,j)}}c.restore()}function s(a){if(a.preventDefault(),F)if(F.type==SEQ.entityParticipant.Type.PARTICIPANT)c(a,F.name);else if(SEQ.entityFragment.regExp.exec(F.type))SEQ.entityFragment.Type.END!=F.type&&(F.elseGuard?c(a,F.elseGuard.text):c(a,F.fragment.text));else if(G)c(a,G.name);else if(F.textData){var b=SEQ.textUtil.buildInputBoxText(F.textData);c(a,b)}}function t(a){var b,c=SEQ.parser.diagram.entries,d=c.indexOf(a);if(SEQ.entityDivider.isType(a.type))b={start:a.raw.indexOf("==")+2,end:a.raw.length-2};else if(SEQ.entityFragment.isType(a.type))b={start:a.type.length+1,end:a.raw.length};else if(SEQ.entityParticipant.isType(a.type))if(a.longName){var e=a.raw.indexOf('"')+1,f=a.raw.indexOf('"',e);b={start:e,end:f}}else b={start:0,end:0};else{var g=a.raw.indexOf(":");b=g>-1?{start:g+1,end:a.raw.length}:{start:0,end:a.raw.length}}SEQ.main.selectInSource(d,b.start,b.end),SEQ.main.focusEditor()}function u(a,b){function c(c){return b<c.startY&&b>c.endY&&a>c.startX&&a<c.endX}for(var d=SEQ.parser.diagram,e=d.entries,f=0;f<e.length;f++){var g=e[f];if(!g.enclosingCollapsedFragment){var h;if(g.collision&&(h=g.collision(g,a,b)),h){if(h===SEQ.entityFragment.CollisionType.TOGGLE)return void v(g);if(h.participantToCreate&&c(h.participantToCreate)&&(G=g.participantToCreate),h.main&&c(h.main)||h.participantToCreate&&c(h.participantToCreate))return g}}}}function v(a){for(var b=SEQ.parser.diagram.entries,c="",d=0;d<b.length;d++){var e=b[d];if(e===a){var f;f=e.raw.indexOf(SEQ.entityFragment.Type.EXPANDABLE_PLUS)>-1?e.raw.replace(SEQ.entityFragment.Type.EXPANDABLE_PLUS,SEQ.entityFragment.Type.EXPANDABLE_MINUS):e.raw.indexOf(SEQ.entityFragment.Type.EXPANDABLE_MINUS)>-1?e.raw.replace(SEQ.entityFragment.Type.EXPANDABLE_MINUS,SEQ.entityFragment.Type.EXPANDABLE_PLUS):e.raw.replace(SEQ.entityFragment.Type.EXPANDABLE_DASH,SEQ.entityFragment.Type.EXPANDABLE_PLUS),c=A(d,b,c,f)}else c=A(d,b,c,e.raw)}SEQ.main.updateSource(c),SEQ.parser.parse()}function w(){var a=SEQ.main.getInteractionContext();return a.clearRect(0,0,a.canvas.width,a.canvas.height),a}function x(a){H||K||(SEQ.messageCreator.paintMessage(a),SEQ.entryMover.continueMove(a)),y(a)}function y(a){if(!a.buttons){var b=SEQ.interactor.getMousePosInCanvas(a),c=SEQ.parser.diagram.collisionTypeAreas.search({minX:b.x,maxX:b.x,minY:b.y,maxY:b.y}),d=SEQ.main.getInteractionCanvas().style;c.length?d.cursor=c[0].type:"auto"!=d.cursor&&(d.cursor="auto")}}function z(a){var b=a.target;document.getElementById("interactionCanvas").contains(b)||(D()?H.contains(b)||i():g());for(var c=document.getElementsByClassName("openSaveMenu"),d=!1,e=0;e<c.length;e++)c[e].contains(b)&&(d=!0);d||SEQ.saveAndOpen.cancel();var h=document.getElementById("contextMenu");h&&!h.contains(b)&&f()}function A(a,b,c,d){return c+=a===b.length-1?d:d+"\n"}function B(){var a;a="none"==document.getElementById("top").style.display?0:100;var b=SEQ.main.getParticipantCanvas();b.style.top=window.pageYOffset+a+"px"}function C(){var a=SEQ.main.getSyntaxErrorsTextarea(),b=a.value.substr(0,a.selectionStart).split("\n").length;if(SEQ.parser.diagram.errors.length){var c=SEQ.parser.diagram.errors[b-1];SEQ.main.selectInSource(c.lineNumber-1,0,c.line.length)}}function D(){return null!=H}var E,F,G,H,I=0,J=0,K=!1;return{init:function(){var a=SEQ.main.getInteractionCanvas();a.addEventListener("mouseup",p,!1),a.addEventListener("mousedown",q,!1),a.addEventListener("mousemove",x,!1),document.onkeydown=j,document.body.onmousedown=z,window.onscroll=B,SEQ.main.getSyntaxErrorsTextarea().onclick=C},prependParticipant:m,cancelAllInteraction:f,editEntryTextAreaActive:D,getMousePosInCanvas:b,displayInputBox:c,setNewEntryData:a,createEntry:o,clearInteractionContext:w,onWindowScroll:B}}();var SEQ=SEQ||{};SEQ.contextMenu=function(){function a(a){if(!SEQ.interactor.editEntryTextAreaActive()){SEQ.interactor.cancelAllInteraction(!0);var f=SEQ.interactor.getMousePosInCanvas(a),j=SEQ.entityParticipant.findParticipantXCollision(f.x,f.y,!1);i={event:a,posY:f.y},h=document.createElement("div"),h.id="contextMenu",document.body.appendChild(h);var k=document.createElement("ul");k.className="contextMenuPart",k.style.width="160px",k.style.top=Math.ceil(a.pageY)+2+"px",k.style.left=Math.ceil(a.pageX)+2+"px",k.onmouseup=g,h.appendChild(k),j&&(e(k,"note",b(SEQ.entityNoteBoxOver.Type.NOTE,j)),e(k,"box",b(SEQ.entityNoteBoxOver.Type.BOX,j)),e(k,"round box",b(SEQ.entityNoteBoxOver.Type.RBOX,j)),e(k,"angular box",b(SEQ.entityNoteBoxOver.Type.ABOX,j)),e(k,"reference",b(SEQ.entityNoteBoxOver.Type.REF,j)),e(k,"activation",d(j))),e(k,"fragment",c(f)),e(k,"divider",null,SEQ.entityDivider.Type.DIVIDER),e(k,"space",null,SEQ.entitySpace.Type.SPACE)}return a.preventDefault(),!1}function b(a,b){var c=document.createElement("ul");c.className="contextMenuPart contextSubMenuPart",a!==SEQ.entityNoteBoxOver.Type.REF&&(f(c,a,SEQ.entityNoteBoxLeftRight.NotePosition.LEFT,b.name),f(c,a,SEQ.entityNoteBoxLeftRight.NotePosition.RIGHT,b.name)),f(c,a,SEQ.entityNoteBoxOver.NotePosition.OVER,b.name);var d=SEQ.parser.diagram.participants;return d.forEach(function(d){d.name!==b.name&&f(c,a,SEQ.entityNoteBoxOver.NotePosition.OVER,b.name+","+d.name)}),h.appendChild(c),c}function c(a){var b=document.createElement("ul");return b.className="contextMenuPart contextSubMenuPart",f(b,SEQ.entityFragment.Type.ALT),SEQ.entityFragment.insideAlt(a)&&f(b,SEQ.entityFragment.Type.ELSE),f(b,SEQ.entityFragment.Type.OPT),f(b,SEQ.entityFragment.Type.LOOP),f(b,SEQ.entityFragment.Type.PAR),f(b,SEQ.entityFragment.Type.GROUP),f(b,SEQ.entityFragment.Type.EXPANDABLE_MINUS),f(b,SEQ.entityFragment.Type.ASSERT),f(b,SEQ.entityFragment.Type.BREAK),f(b,SEQ.entityFragment.Type.CONSIDER),f(b,SEQ.entityFragment.Type.CRITICAL),f(b,SEQ.entityFragment.Type.IGNORE),f(b,SEQ.entityFragment.Type.NEG),f(b,SEQ.entityFragment.Type.SEQ),f(b,SEQ.entityFragment.Type.STRICT),h.appendChild(b),b}function d(a){var b=document.createElement("ul");return b.className="contextMenuPart contextSubMenuPart",f(b,SEQ.entityActivation.Type.ACTIVATE,null,a.name),f(b,SEQ.entityActivation.Type.DEACTIVATE,null,a.name),f(b,SEQ.entityActivation.Type.DEACTIVATE_AFTER,null,a.name),h.appendChild(b),b}function e(a,b,c,d){var e=document.createElement("li");a.appendChild(e),e.className="mainMenuListElement",c?(e.innerHTML='<span style="float: right">&gt;</span>'+b,c.style.top=Math.ceil(e.getBoundingClientRect().top+window.pageYOffset)-2+"px",c.style.left=Math.ceil(a.getBoundingClientRect().right+window.pageXOffset)-2+"px",c.onmouseup=g):e.innerHTML=b,d&&e.setAttribute("data-entry-type",d),e.onmouseover=function(){for(var a=document.getElementsByClassName("contextSubMenuPart"),b=0;b<a.length;b++)a[b].style.display="none";for(var d=document.getElementsByClassName("mainMenuListElement"),f=0;f<d.length;f++)d[f].style.backgroundColor="#ffffff";e.style.backgroundColor="#b0dcea",c&&(c.style.display="block")}}function f(a,b,c,d,e){var f=document.createElement("li");f.setAttribute("data-entry-type",b),d&&f.setAttribute("data-entry-participants",d),c&&f.setAttribute("data-entry-note-position",c),e?f.innerHTML=e:c&&d?f.innerHTML=b+" "+c+" "+d:d?f.innerHTML=b+" "+d:f.innerHTML=b,a.appendChild(f)}function g(a){var b=a.target,c=b.getAttribute("data-entry-type"),d=b.getAttribute("data-entry-note-position"),e=b.getAttribute("data-entry-participants");if(c){document.body.removeChild(h),h=null;var f={participants:e,posY:i.posY,type:c,notePosition:d};SEQ.interactor.setNewEntryData(f),SEQ.entityActivation.isType(c)||SEQ.entitySpace.isType(c)?SEQ.interactor.createEntry(f):SEQ.interactor.displayInputBox(i.event),i=null}}var h,i;return{init:function(){var b=SEQ.main.getInteractionCanvas();b.addEventListener("contextmenu",a,!1)},active:function(){return null!=h},cancel:function(){h&&document.body.removeChild(h),i=null,h=null}}}();var SEQ=SEQ||{};SEQ.messageCreator=function(){function a(a,b){var c=SEQ.interactor.getMousePosInCanvas(a);e={shift:a.shiftKey,ctrl:a.ctrlKey,x:c.x,y:c.y,participant:b}}function b(a){var b=SEQ.interactor.getMousePosInCanvas(a);if(e){var c=SEQ.entityParticipant.findParticipantXCollision(e.x,e.y,!1),d=SEQ.entityParticipant.findParticipantXCollision(b.x,b.y,!1);if(c&&d&&(Math.abs(b.y-e.y)>SEQ.metrics.data.messageCreatorPosDiffThreshold||Math.abs(b.x-e.x)>SEQ.metrics.data.messageCreatorInteractionMargin&&c!=d)){var f;f=d.posX>=c.posX?e.shift?e.ctrl?SEQ.entityMessage.Type.RESP_FORWARD_ASYNC:SEQ.entityMessage.Type.RESP_FORWARD_SYNC:e.ctrl?SEQ.entityMessage.Type.REQ_FORWARD_ASYNC:SEQ.entityMessage.Type.REQ_FORWARD_SYNC:e.shift?e.ctrl?SEQ.entityMessage.Type.RESP_BACKWARD_ASYNC:SEQ.entityMessage.Type.RESP_BACKWARD_SYNC:e.ctrl?SEQ.entityMessage.Type.REQ_BACKWARD_ASYNC:SEQ.entityMessage.Type.REQ_BACKWARD_SYNC;var g=(e.y+b.y)/2,h={fromParticipantName:c.name,toParticipantName:d.name,posY:g,type:f};return SEQ.interactor.setNewEntryData(h),SEQ.interactor.displayInputBox(a),!0}SEQ.interactor.cancelAllInteraction(),e=null}}function c(a){e&&(a.preventDefault(),d(a))}function d(a){var b=SEQ.interactor.clearInteractionContext();if(e){var c=SEQ.interactor.getMousePosInCanvas(a);b.save(),e.shift&&void 0!==b.setLineDash&&b.setLineDash([SEQ.metrics.data.messageLineDashWidth]);var d;if(Math.abs(e.participant.posX-c.x)<SEQ.metrics.data.messageCreatorInteractionMargin&&Math.abs(c.y-e.y)>SEQ.metrics.data.messageCreatorPosDiffThreshold){d=!1,b.beginPath();var f=SEQ.metrics.data.messageSelfRefWidth,g=e.participant.posX;b.moveTo(e.participant.posX,e.y),b.lineTo(g+f,e.y),b.lineTo(g+f,c.y),b.lineTo(c.x,c.y),b.stroke()}else{var h;h=c.x>e.participant.posX?e.participant.posX+e.participant.timelineRightWidth:e.participant.posX-e.participant.timelineLeftWidth;var i=c.x>e.participant.posX?-1*SEQ.metrics.data.messageArrowWidth:SEQ.metrics.data.messageArrowWidth;d=e.participant.posX<c.x,b.beginPath(),b.moveTo(h,e.y),b.lineTo(c.x+i,c.y),b.stroke()}b.restore(),SEQ.entityMessage.paintArrowHead(c.y,d,c.x,b,e.ctrl)}}var e;return{init:function(){var a=SEQ.main.getInteractionCanvas();a.addEventListener("contextmenu",onCanvasContextMenu,!1)},cancel:function(){e=null},startMessage:a,finishMessage:b,paintMessage:c}}();var SEQ=SEQ||{};SEQ.entryMover=function(){function a(a){i&&(r=0,s=0,a.clientY<50?s=-20:a.clientY>window.innerHeight-50&&(s=20),a.clientX<50?r=-20:a.clientX>window.innerWidth-50&&(r=20),0!=r||0!=s?t||(t=!0,u()):t=!1)}function b(a,b){if(b.calcPosX){var c=b.calcPosX(b);k=c.fromX,l=c.toX}i=null,o=!1,p=!1,q=!1,j=b;var d=SEQ.interactor.getMousePosInCanvas(a);b.toParticipantName?(!b.participantToCreate&&Math.abs(d.x-l)<SEQ.metrics.data.entryMoverXCollisionWidth&&(p=!0),Math.abs(d.x-k)<SEQ.metrics.data.entryMoverXCollisionWidth&&(o=!0),o&&p&&(Math.abs(d.x-l)>Math.abs(d.x-k)?(p=!1,o=!0):(p=!0,o=!1))):b.notePosition===SEQ.entityNoteBoxOver.NotePosition.OVER?Math.abs(d.x-k)>b.totalWidth/2-1.5*SEQ.metrics.data.entryMoverXCollisionWidth?(l=k,q=!0,d.x>k?p=!0:o=!0):o=!0:b.fromParticipantName&&!b.lockedPosX&&(o=!0),m=j.posY-d.y,n=d}function c(a){return Math.abs(n.y-a.y)>SEQ.metrics.data.entryMoverThreshold||Math.abs(n.x-a.x)>SEQ.metrics.data.entryMoverThreshold}function d(){j=null,i=null,o=!1,p=!1,t=!1,r=0,s=0,window.removeEventListener("mousemove",a,!1)}function e(a){var b=SEQ.interactor.getMousePosInCanvas(a);if(i&&c(b)){var e=i.raw;if(o){var g=SEQ.entityParticipant.findParticipantXCollision(b.x,b.y,!0);g&&(i.notePosition===SEQ.entityNoteBoxOver.NotePosition.OVER&&i.toParticipantName===g.name?(i.fromParticipantName=g.name,i.toParticipantName=null):i.fromParticipantName=g.name,e=i.buildRaw(i))}else if(p){var h=SEQ.entityParticipant.findParticipantXCollision(b.x,b.y,!0);h&&(i.notePosition===SEQ.entityNoteBoxOver.NotePosition.OVER&&i.fromParticipantName===h.name?(i.fromParticipantName=h.name,i.toParticipantName=null):i.toParticipantName=h.name,e=i.buildRaw(i))}for(var k=SEQ.parser.diagram.entries,l=!1,n="",q=0;q<k.length;q++){var r=k[q];!l&&r.type&&b.y+m<r.posY&&(n=f(q,n,e),l=!0,0===q&&(n+="\n")),r!=j&&(n=f(q,n,r.raw))}l||(n+="\n"+e),SEQ.main.updateSource(n),SEQ.parser.parse()}i&&SEQ.interactor.clearInteractionContext(),d()}function f(a,b,c){return b+=0===a?c:"\n"+c}function g(b){if(b.preventDefault(),j&&!i){var d=SEQ.interactor.getMousePosInCanvas(b);c(d)&&(window.addEventListener("mousemove",a,!1),i=JSON.parse(JSON.stringify(j)),i.paint=j.paint,j.participantToCreate&&(i.participantToCreate=j.participantToCreate),i.updatePos=j.updatePos,i.buildRaw=j.buildRaw,q&&(i.toParticipantName=i.fromParticipantName))}else i&&h(b)}function h(a){var b=SEQ.interactor.clearInteractionContext();if(i){var c=SEQ.interactor.getMousePosInCanvas(a);b.save(),b.globalAlpha=.5,o?i.updatePos(i,c.y+m,c.x,l):p?i.updatePos(i,c.y+m,k,c.x):i.updatePos(i,c.y+m,k,l),i.paint(i,b,!1,!0),b.restore()}}var i,j,k,l,m,n,o,p,q,r,s,t=!1,u=function(){0==r&&0==s||!i||(window.scrollBy(r,s),setTimeout(u,40))};return{cancel:function(){d()},startMove:b,finishMove:e,continueMove:g}}();var SEQ=SEQ||{};SEQ.textUtil=function(){function a(a,b){var c=a.split("\\n"),d=0,e=0,f=!1,g=!1,m=j.normal,n="black",o=[];c.forEach(function(a){var b=0;a=a.replace(/\\(\+|\-|\/|\*)/g,"=-=ESCAPE_CHAR_BEGIN=-=$1=-=ESCAPE_CHAR_END=-=");var c,p=a.split(/(\*\*|\/\/|\+\+|\-\-|<color [^>]+>|<\/color>)/),q=[],r=0;p.forEach(function(a){var d;if("**"===a)f=!f;else if("//"!==a||c&&(c.indexOf("http:")>-1||c.indexOf("https:")>-1||c.indexOf("ftp:")>-1||c.indexOf("gopher:")>-1||c.indexOf("file:")>-1))if("--"===a)m=m===j.small?j.normal:j.small;else if("++"===a)m=m===j.big?j.normal:j.big;else if((d=k.exec(a))&&d.length>0){var e=l.exec(d[1]);e&&(e[1]?n=e[1]:e[2]&&(n=e[2]))}else if("</color>"===a)n="black";else{var o,p;j.small==m?(o=SEQ.main.getFontSmall(),p=SEQ.metrics.data.textSmallLineHeight):j.big==m?(o=SEQ.main.getFontBig(),p=SEQ.metrics.data.textBigLineHeight):(o=SEQ.main.getFontNormal(),p=SEQ.metrics.data.textLineHeight),f&&(o=h+o),g&&(o=i+o),a=a.replace(/=-=ESCAPE_CHAR_BEGIN=-=(.)=-=ESCAPE_CHAR_END=-=/g,"$1");var s=SEQ.metrics.calcWidth(a,o);b+=s,q.push({part:a,font:o,color:n,width:s,height:p}),p>r&&(r=p)}else g=!g;c=a}),e+=r,o.push({partsWithFonts:q,lineMaxHeight:r,lineWidth:b}),b>d&&(d=b)});var p;return b&&(p=SEQ.metrics.calcWidth(b+" ","bold "+SEQ.main.getFontNormal()),d+=p),{parsedLines:o,lines:c,width:d,height:e+SEQ.metrics.data.textTopBottomPadding,autoNumberWidth:p}}function b(a,b,d,f,g,h,i,j){a.save(),j&&c(a,d,f,g,h,i,j),e(a,b,d,f,g,h,i),a.restore()}function c(a,b,c,d,e,f){var g=d+SEQ.metrics.data.textTopBottomPadding/2-SEQ.metrics.data.textPosYOffset,h=!0;b.forEach(function(b){var d,i;h&&e&&f?(c+=f,d=c-f-SEQ.metrics.data.textTopBottomPadding/2,i=b.lineWidth+SEQ.metrics.data.textTopBottomPadding+f,h=!1):(d=c-SEQ.metrics.data.textTopBottomPadding/2,i=b.lineWidth+SEQ.metrics.data.textTopBottomPadding),a.save(),a.fillStyle="white",a.beginPath(),a.fillRect(d,g+SEQ.metrics.data.textPosYOffset-SEQ.metrics.data.textTopBottomPadding/2,i,b.lineMaxHeight+SEQ.metrics.data.textTopBottomPadding),a.restore(),g+=b.lineMaxHeight})}function d(a,b,c,d,e){var f=e;c.forEach(function(c){var e=c.partsWithFonts;f+=c.lineMaxHeight;var g=0;e.forEach(function(b){a.font=b.font,g+=b.width});var h=d-g/2;e.forEach(function(c){a.font=c.font,b||(a.fillStyle=c.color),a.fillText(c.part,h,f),h+=c.width})})}function e(a,b,c,d,e,f,g){f&&g&&(d+=g);var h=e-SEQ.metrics.data.textPosYOffset,i=!0;c.forEach(function(c){var e=c.partsWithFonts;h+=c.lineMaxHeight;var j=d;if(e.forEach(function(c){a.font=c.font,b||(a.fillStyle=c.color),a.fillText(c.part,j,h),j+=c.width}),f&&i){a.save(),a.font="bold "+SEQ.main.getFontNormal();var k=f+" ";a.fillText(k,d-g,h),a.restore(),i=!1}})}function f(a){var b="",c=0;return a.lines.forEach(function(d){b+=d,c<a.lines.length-1&&(b+="\\n"),c++}),b}function g(a){var b="",c=0;return a.lines.forEach(function(d){b+=d,c<a.lines.length-1&&(b+="\n"),c++}),b}var h="bold ",i="italic ",j={normal:"normal",small:"small",big:"big"},k=new RegExp("<color (.+)>"),l=new RegExp("(?:\\s?(#[a-fA-F0-9]{6})|(?:\\s?#)([a-zA-Z]{3,20}))");return{parseTextData:a,buildInputBoxText:g,buildSourceText:f,fillText:b,fillTextParticipant:d}}();var SEQ=SEQ||{};SEQ.participantTypes=function(){function a(a,b,c,d,e,f,g,h){for(var i=g;i<h;i+=.01){var j=b-e*Math.sin(i)*Math.sin(f)+d*Math.cos(i)*Math.cos(f),k=c+d*Math.cos(i)*Math.sin(f)+e*Math.sin(i)*Math.cos(f);0==i?a.moveTo(j,k):a.lineTo(j,k)}}function b(a,b){a.color?b.fillStyle=a.color:b.fillStyle="white",b.fill()}function c(){return 3.14*SEQ.metrics.data.baseSpaceMetric-SEQ.metrics.data.participantTypeLineWeight}return{fontawesome:{paint:function(a,b,c,d){var e=b.longNameTextData?b.longNameTextData.height:SEQ.metrics.data.textLineHeight+SEQ.metrics.data.textTopBottomPadding,f=c+d-e-SEQ.metrics.data.baseSpaceMetric/3;
a.save(),a.font=SEQ.main.getFontFontAwesome();var g=SEQ.metrics.calcWidth(b.iconUnicode,SEQ.main.getFontFontAwesome());b.color&&(a.fillStyle=b.color),a.fillText(b.iconUnicode,b.posX-g/2,f),a.restore()},width:function(a){return SEQ.metrics.calcWidth(a,SEQ.main.getFontFontAwesome())},height:function(a){return SEQ.metrics.calcHeight(SEQ.main.getFontFontAwesome(),a,SEQ.main.getFontIconSize())}},materialdesignicons:{paint:function(a,b,c,d){var e=b.longNameTextData?b.longNameTextData.height:SEQ.metrics.data.textLineHeight+SEQ.metrics.data.textTopBottomPadding,f=c+d-e;a.save(),a.font=SEQ.main.getFontMaterialDesignIcons();var g=SEQ.metrics.calcWidth(b.iconUnicode,SEQ.main.getFontFontAwesome());b.color&&(a.fillStyle=b.color),a.fillText(b.iconUnicode,b.posX-g/2,f),a.restore()},width:function(a){return SEQ.metrics.calcWidth(a,SEQ.main.getFontMaterialDesignIcons())},height:function(a){var b=SEQ.metrics.calcHeight(SEQ.main.getFontMaterialDesignIcons(),a,SEQ.main.getFontIconSize());return b}},actor:{paint:function(a,c,d,e){var f=c.longNameTextData?c.longNameTextData.height:SEQ.metrics.data.textLineHeight+SEQ.metrics.data.textTopBottomPadding,g=SEQ.metrics.data.baseSpaceMetric,h=d+e-f,i=3.5*g,j=.57*g,k=1.22*g,l=.72*g,m=.44*g+2*j;a.save(),a.lineWidth=SEQ.metrics.data.participantTypeLineWeight,a.beginPath(),a.arc(c.posX,h-i+j,j,0,2*Math.PI),a.moveTo(c.posX,h-i+2*j),a.lineTo(c.posX,h-i+2*j+k),a.moveTo(c.posX-l,h-i+m),a.lineTo(c.posX+l,h-i+m),a.moveTo(c.posX,h-i+2*j+k),a.lineTo(c.posX-l,h),a.moveTo(c.posX,h-i+2*j+k),a.lineTo(c.posX+l,h),b(c,a),a.stroke(),a.restore()},width:function(){return.72*SEQ.metrics.data.baseSpaceMetric*2},height:function(){return 3.5*SEQ.metrics.data.baseSpaceMetric+SEQ.metrics.data.participantTypeLineWeight/2}},boundary:{paint:function(a,d,e,f){var g=d.longNameTextData?d.longNameTextData.height:SEQ.metrics.data.textLineHeight+SEQ.metrics.data.textTopBottomPadding,h=c(),i=f+e-g-h/2-SEQ.metrics.data.participantTypeLineWeight/2,j=h/2,k=SEQ.metrics.data.baseSpaceMetric/2;a.save(),a.lineWidth=SEQ.metrics.data.participantTypeLineWeight,a.beginPath(),a.arc(d.posX+k,i,j,0,2*Math.PI),a.moveTo(d.posX-j-k+SEQ.metrics.data.participantTypeLineWeight/2,i-j-SEQ.metrics.data.participantTypeLineWeight/2),a.lineTo(d.posX-j-k+SEQ.metrics.data.participantTypeLineWeight/2,i+j+SEQ.metrics.data.participantTypeLineWeight/2),a.moveTo(d.posX-j-k,i),a.lineTo(d.posX-j+k,i),b(d,a),a.stroke(),a.restore()},width:function(){return c()+SEQ.metrics.data.baseSpaceMetric/2+SEQ.metrics.data.participantTypeLineWeight},height:function(){return c()+SEQ.metrics.data.participantTypeLineWeight}},control:{paint:function(a,d,e,f){var g=d.longNameTextData?d.longNameTextData.height:SEQ.metrics.data.textLineHeight+SEQ.metrics.data.textTopBottomPadding,h=c(),i=f+e-g-h/2-SEQ.metrics.data.participantTypeLineWeight/2,j=h/2,k=.6*SEQ.metrics.data.baseSpaceMetric,l=SEQ.metrics.data.baseSpaceMetric/2,m=d.posX-.2*SEQ.metrics.data.baseSpaceMetric;a.save(),a.lineWidth=SEQ.metrics.data.participantTypeLineWeight,a.beginPath(),a.arc(d.posX,i,j,0,2*Math.PI),a.moveTo(m,i-j),a.lineTo(m+k,i-j-l),a.moveTo(m,i-j),a.lineTo(m+k,i-j+l),b(d,a),a.stroke(),a.restore()},width:function(){return c()+SEQ.metrics.data.participantTypeLineWeight},height:function(){return c()+SEQ.metrics.data.participantTypeLineWeight+SEQ.metrics.data.baseSpaceMetric/2}},entity:{paint:function(a,d,e,f){var g=d.longNameTextData?d.longNameTextData.height:SEQ.metrics.data.textLineHeight+SEQ.metrics.data.textTopBottomPadding,h=c(),i=f+e-g-h/2-SEQ.metrics.data.participantTypeLineWeight/2,j=h/2;a.save(),a.lineWidth=SEQ.metrics.data.participantTypeLineWeight,a.beginPath(),a.arc(d.posX,i-.8*SEQ.metrics.data.participantTypeLineWeight,j,0,2*Math.PI),a.moveTo(d.posX-j-SEQ.metrics.data.participantTypeLineWeight/2,i+j),a.lineTo(d.posX+j-SEQ.metrics.data.participantTypeLineWeight/2,i+j),b(d,a),a.stroke(),a.restore()},width:function(){return c()+SEQ.metrics.data.participantTypeLineWeight},height:function(){return c()+1.8*SEQ.metrics.data.participantTypeLineWeight}},database:{paint:function(c,d,e,f){var g=d.longNameTextData?d.longNameTextData.height:SEQ.metrics.data.textLineHeight+SEQ.metrics.data.textTopBottomPadding,h=SEQ.metrics.data.baseSpaceMetric,i=e+f-g,j=3.42*h,k=.66*h,l=2.92*h,m=1.46*h,n=.073*h;c.save(),c.lineWidth=SEQ.metrics.data.participantTypeLineWeight,c.beginPath(),c.moveTo(d.posX-l/2,i-k),c.lineTo(d.posX-l/2,i-j+k),c.lineTo(d.posX+l/2,i-j+k),c.lineTo(d.posX+l/2,i-k),b(d,c),c.stroke(),c.beginPath(),a(c,d.posX,i-j+k-n,m,k,0,0,2*Math.PI),a(c,d.posX,i-k-n,m,k,0,0,Math.PI),b(d,c),c.stroke(),c.restore()},width:function(){return 4*SEQ.metrics.data.baseSpaceMetric},height:function(){return 3.42*SEQ.metrics.data.baseSpaceMetric+SEQ.metrics.data.participantTypeLineWeight}}}}();var SEQ=SEQ||{};SEQ.saveAndOpen=function(){function a(){document.getElementById("saveSourceMenu").style.display="none",document.getElementById("openSourceMenu").style.display="none"}function b(b){var c=b.files;if(window.File&&window.FileReader&&window.FileList&&window.Blob){var d=c[0],e=new FileReader;e.onload=function(c){SEQ.main.updateSource(c.target.result),SEQ.main.parse(),b.form.reset(),a()},e.readAsText(d)}else alert("The JavaScript file APIs are not fully supported in this browser.")}function c(b){var c=this.diagramName;if("delete"===b.target.innerHTML){var d=confirm('Are you sure you want to delete "'+c+'"?');d&&(localStorage.removeItem(c),i())}else{var e=localStorage.getItem(c);SEQ.main.updateSource(e),SEQ.main.parse(),a()}}function d(){var b=document.getElementById("fileName").value,c=SEQ.main.getSourceValue();navigator.appVersion.indexOf("Win")!=-1&&(c=c.replace(/\n/g,"\r\n"));var d=new Blob([c],{type:"text/plain"});if(navigator.msSaveBlob)navigator.msSaveBlob(d,b);else{var e=document.createElement("a");e.download=b,e.innerHTML="download source",e.onclick=function(a){document.body.removeChild(a.target)};var f=window.URL||window.webkitURL;e.href=f.createObjectURL(d),e.style.display="none",document.body.appendChild(e),e.click()}a()}function e(){var a=(SEQ.parser.diagram.title?SEQ.parser.diagram.title.title:"no title")+".png",b=SEQ.main.getDiagramCanvas();if(b.msToBlob){var c=b.msToBlob();window.navigator.msSaveBlob(c,a)}else{var d=document.getElementById("pnghq"),e=b.toDataURL("image/png");d.download=a,d.href=e}}function f(){var a=(SEQ.parser.diagram.title?SEQ.parser.diagram.title.title:"no title")+".jpg",b=SEQ.main.getDiagramCanvas(),c=b.toDataURL("image/jpeg",.1),d=document.getElementById("jpglq");if(b.msToBlob){var e=window.open("about:blank");e.document.write("<img src='"+c+"'/>")}else d.download=a,d.href=c}function g(){var a=SEQ.main.getDiagramCanvas(),b=new C2S(a.width,a.height);SEQ.main.setCanvasToSvgContext(b),SEQ.parser.parse();var c=b.getSerializedSvg(),d="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(c);return SEQ.main.setCanvasToSvgContext(null),SEQ.parser.parse(),d}function h(){var a=(SEQ.parser.diagram.title?SEQ.parser.diagram.title.title:"no title")+".svg",b=g();if(SEQ.main.getDiagramCanvas().msToBlob)window.alert("Please use Chrome or Firefox for svg export");else{var c=document.createElement("a");c.onclick=function(a){document.body.removeChild(a.target)},c.href=b,c.download=a,c.style.display="none",document.body.appendChild(c),c.click()}}function i(a){if(a){var b=a.getBoundingClientRect(),d=document.getElementById("openSourceMenu");d.style.top=b.top+"px",d.style.left=b.right+"px",d.style.display="block"}for(var e=document.getElementById("localStorageSources");e.firstChild;)e.removeChild(e.firstChild);var f=document.createElement("table");if(e.appendChild(f),localStorage.length)for(var g=0;g<localStorage.length;g++){var h=document.createElement("tr");h.diagramName=localStorage.key(g);var i=document.createElement("td");i.innerHTML=localStorage.key(g)+"&nbsp;",h.onclick=c,h.appendChild(i);var j=document.createElement("td");j.style.textAlign="right";var k=document.createElement("button");k.innerHTML="delete",j.appendChild(k),h.appendChild(j),f.appendChild(h)}else{var l=document.createElement("span");l.innerHTML="no diagrams found",e.appendChild(l)}}return{saveSource:function(a){var b=a.getBoundingClientRect(),c=document.getElementById("saveSourceMenu");c.style.display="block",c.style.top=b.top+"px",c.style.left=b.right+"px";var d=document.getElementById("fileName");d.focus(),d.select();var e=SEQ.parser.diagram.title?SEQ.parser.diagram.title.title:"no title";document.getElementById("fileName").value=e+".txt"},openSource:i,openSourceFromFile:b,saveSourceIntoFile:d,saveSourceIntoLocalStorage:function(){var b=document.getElementById("fileName").value;localStorage.setItem(b,SEQ.main.getSourceValue()),a()},openSourceFromLocalStorage:c,savePngHq:e,saveJpgLq:f,saveSvg:h,create:function(a){localStorage.setItem(a,SEQ.main.getSourceValue())},cancel:a,paintSvgCanvas:g}}();var SEQ=SEQ||{};SEQ.seqDiaHint=function(){"use strict";function a(){b(SEQ.entityNoteBoxOver,e),b(SEQ.entityNoteBoxLeftRight,e),b(SEQ.entityActivation,e),b(SEQ.entityCreateDestroy,e),b(SEQ.entityDivider,f),b(SEQ.entityFragment,f),b(SEQ.entityTitle,f),b(SEQ.entityParticipant,f),b(SEQ.entityLinear,f),b(SEQ.entityParallel,f),b(SEQ.entityAutoNumber,f),b(SEQ.entityFontFamily,f),b(SEQ.entityFontSize,f),b(SEQ.entitySpace,f),b(SEQ.entityParticipantSpacing,f),b(SEQ.entityEntrySpacing,f),b(SEQ.entityActiveColor,f),b(SEQ.entityLifeLineColor,f),b(SEQ.entityLifeLineWeight,f),b(SEQ.entityMessage,g)}function b(a,b){if(a.NotePosition){for(var c in a.Type)if(a.Type.hasOwnProperty(c))for(var d in a.NotePosition)a.NotePosition.hasOwnProperty(d)&&b.push(a.Type[c]+" "+a.NotePosition[d])}else for(var e in a.Type)a.Type.hasOwnProperty(e)&&b.push(a.Type[e])}function c(a){for(var b=0;b<e.length;b++){var c=e[b];if(0===a.replace(/^\s+/,"").lastIndexOf(c+" "))return{participantPart:a.replace(c,"").trim(),start:a.indexOf(c)+c.length+1}}return!1}function d(a){var b,d=a.getCursor(),h=a.getLine(d.line).substring(0,d.ch),i=[],j=d.ch,k=j;if(SEQ.entityMessage.regExpArrow.test(h)){for(;k&&">"!==h.charAt(k-1)&&"-"!==h.charAt(k-1);)k--;b=h.slice(k,j).trim(),SEQ.parser.diagram.participants.forEach(function(a){0===a.name.lastIndexOf(b,0)&&i.push(a.name)})}else if(SEQ.parser.diagram.participantsByName[h.trim()])i=g;else{for(k=0;" "===h.charAt(k);)k++;if(b=h.replace(/^\s+/,""),0===b.length)SEQ.parser.diagram.participants.forEach(function(a){i.push(a.name)}),e.forEach(function(a){i.push(a+" ")}),f.forEach(function(a){i.push(a+" ")});else if("#"===b.charAt(0)||":"===b.charAt(b.length-1));else{var l=c(h);l?(k=l.start,SEQ.parser.diagram.participants.forEach(function(a){0===a.name.lastIndexOf(l.participantPart,0)&&i.push(a.name)})):(SEQ.parser.diagram.participants.forEach(function(a){0===a.name.lastIndexOf(b,0)&&i.push(a.name)}),e.forEach(function(a){0===a.indexOf(b.trim(),0)&&i.push(a+" ")}),f.forEach(function(a){0===a.indexOf(b.trim(),0)&&i.push(a+" ")}))}}return{list:i,from:CodeMirror.Pos(d.line,k),to:CodeMirror.Pos(d.line,j)}}var e=[],f=[],g=[];return{init:function(){a(),CodeMirror.registerHelper("hint","seqdiahint",function(a){return d(a)})}}}();var SEQ=SEQ||{};SEQ.seqDiaMode=function(){"use strict";function a(){var a=function(a){for(var b;!b&&a.currentGroup<a.maxGroup;)a.currentGroup++,b=a.match[a.currentGroup];return b?(a.pos=a.string.indexOf(b,a.pos)+b.length,a.groupMapping[a.currentGroup].style):void a.skipToEnd()},b={};b.regExp=SEQ.entityMessage.regExp,b.maxGroup=SEQ.entityMessage.groups.TEXT,b.handleSecondPartOfType=!1,b.groupMapping={},b.groupMapping[SEQ.entityMessage.groups.PARTICIPANT_1]={style:c.ACTOR},b.groupMapping[SEQ.entityMessage.groups.TYPE]={style:c.ARROW},b.groupMapping[SEQ.entityMessage.groups.COLOR_HEX_3]={style:c.PARAMETER},b.groupMapping[SEQ.entityMessage.groups.COLOR_NAME_4]={style:c.PARAMETER},b.groupMapping[SEQ.entityMessage.groups.COLOR_HEX_5]={style:c.PARAMETER},b.groupMapping[SEQ.entityMessage.groups.COLOR_NAME_6]={style:c.PARAMETER},b.groupMapping[SEQ.entityMessage.groups.COLOR_HEX_7]={style:c.PARAMETER},b.groupMapping[SEQ.entityMessage.groups.COLOR_NAME_8]={style:c.PARAMETER},b.groupMapping[SEQ.entityMessage.groups.PARTICIPANT_2]={style:c.ACTOR},b.groupMapping[SEQ.entityMessage.groups.TEXT]={style:c.TEXT},b.progressStream=function(a){if(a.handleSecondPartOfType)return a.pos+=a.typeMatchPart.length-a.typeMatchPart.indexOf("#")-a.colorLength,a.handleSecondPartOfType=!1,b.groupMapping[SEQ.entityMessage.groups.TYPE].style;for(var c;!c&&a.currentGroup<a.maxGroup;)a.currentGroup++,c=a.match[a.currentGroup];if(c){var d=a.groupMapping[a.currentGroup];if(a.currentGroup===SEQ.entityMessage.groups.TYPE&&c.indexOf("#")!==-1)return a.pos+=c.indexOf("#"),a.typeMatchPart=c,b.groupMapping[SEQ.entityMessage.groups.TYPE].style;if(a.currentGroup>=SEQ.entityMessage.groups.COLOR_HEX_3&&a.currentGroup<=SEQ.entityMessage.groups.COLOR_NAME_8){var e=c.length;return c.indexOf("#")===-1&&(e+=1),a.pos+=e,a.colorLength=e,a.handleSecondPartOfType=!0,d.style}return a.pos=a.string.indexOf(c,a.pos)+c.length,d.style}a.skipToEnd()},d.push(b);var e={};e.regExp=SEQ.entityNoteBoxOver.regExp,e.maxGroup=SEQ.entityNoteBoxOver.groups.TEXT,e.groupMapping={},e.groupMapping[SEQ.entityNoteBoxOver.groups.TYPE]={style:c.KEYWORD},e.groupMapping[SEQ.entityNoteBoxOver.groups.SIDE]={style:c.KEYWORD},e.groupMapping[SEQ.entityNoteBoxOver.groups.PARTICIPANT_FROM]={style:c.ACTOR},e.groupMapping[SEQ.entityNoteBoxOver.groups.PARTICIPANT_TO]={style:c.ACTOR},e.groupMapping[SEQ.entityNoteBoxOver.groups.COLOR_HEX]={style:c.PARAMETER},e.groupMapping[SEQ.entityNoteBoxOver.groups.COLOR_NAME]={style:c.PARAMETER},e.groupMapping[SEQ.entityNoteBoxOver.groups.TEXT]={style:c.TEXT},e.progressStream=a,d.push(e);var f={};f.regExp=SEQ.entityNoteBoxLeftRight.regExp,f.maxGroup=SEQ.entityNoteBoxLeftRight.groups.TEXT,f.groupMapping={},f.groupMapping[SEQ.entityNoteBoxLeftRight.groups.TYPE]={style:c.KEYWORD},f.groupMapping[SEQ.entityNoteBoxLeftRight.groups.SIDE]={style:c.KEYWORD},f.groupMapping[SEQ.entityNoteBoxLeftRight.groups.PARTICIPANT_FROM]={style:c.ACTOR},f.groupMapping[SEQ.entityNoteBoxLeftRight.groups.COLOR_HEX]={style:c.PARAMETER},f.groupMapping[SEQ.entityNoteBoxLeftRight.groups.COLOR_NAME]={style:c.PARAMETER},f.groupMapping[SEQ.entityNoteBoxLeftRight.groups.TEXT]={style:c.TEXT},f.progressStream=a,d.push(f);var g={};g.regExp=SEQ.entityFragment.regExp,g.maxGroup=SEQ.entityFragment.groups.GROUP_CONDITION_RIGHT_BRACKET,g.groupMapping={},g.groupMapping[SEQ.entityFragment.groups.OPERATOR]={style:c.KEYWORD},g.groupMapping[SEQ.entityFragment.groups.GROUP]={style:c.KEYWORD},g.groupMapping[SEQ.entityFragment.groups.GROUP_LABEL]={style:c.TEXT},g.groupMapping[SEQ.entityFragment.groups.GROUP_CONDITION_LEFT_BRACKET]={style:c.KEYWORD},g.groupMapping[SEQ.entityFragment.groups.GROUP_CONDITION]={style:c.TEXT},g.groupMapping[SEQ.entityFragment.groups.GROUP_CONDITION_RIGHT_BRACKET]={style:c.KEYWORD},g.groupMapping[SEQ.entityFragment.groups.TEXT]={style:c.TEXT},g.progressStream=a,d.push(g);var h={};h.regExp=SEQ.entityActivation.regExp,h.maxGroup=SEQ.entityActivation.groups.COLOR_NAME,h.groupMapping={},h.groupMapping[SEQ.entityActivation.groups.TYPE]={style:c.KEYWORD},h.groupMapping[SEQ.entityActivation.groups.PARTICIPANT]={style:c.ACTOR},h.groupMapping[SEQ.entityActivation.groups.COLOR_HEX]={style:c.PARAMETER},h.groupMapping[SEQ.entityActivation.groups.COLOR_NAME]={style:c.PARAMETER},h.progressStream=a,d.push(h);var i={};i.regExp=SEQ.entityAutoNumber.regExp,i.maxGroup=SEQ.entityAutoNumber.groups.STATUS,i.groupMapping={},i.groupMapping[SEQ.entityAutoNumber.groups.AUTO_NUMBER]={style:c.KEYWORD},i.groupMapping[SEQ.entityAutoNumber.groups.STATUS]={style:c.PARAMETER},i.progressStream=a,d.push(i);var j={};j.regExp=SEQ.entityDivider.regExp,j.maxGroup=SEQ.entityDivider.groups.COLOR_NAME,j.groupMapping={},j.groupMapping[SEQ.entityDivider.groups.EQUALS_1]={style:c.KEYWORD},j.groupMapping[SEQ.entityDivider.groups.TEXT]={style:c.TEXT},j.groupMapping[SEQ.entityDivider.groups.EQUALS_2]={style:c.KEYWORD},j.groupMapping[SEQ.entityDivider.groups.COLOR_HEX]={style:c.PARAMETER},j.groupMapping[SEQ.entityDivider.groups.COLOR_NAME]={style:c.PARAMETER},j.progressStream=a,d.push(j);var k={};k.regExp=SEQ.entityEntrySpacing.regExp,k.maxGroup=SEQ.entityEntrySpacing.groups.SPACING,k.groupMapping={},k.groupMapping[SEQ.entityEntrySpacing.groups.ENTRY_SPACING]={style:c.KEYWORD},k.groupMapping[SEQ.entityEntrySpacing.groups.SPACING]={style:c.PARAMETER},k.progressStream=a,d.push(k);var l={};l.regExp=SEQ.entityFontFamily.regExp,l.maxGroup=SEQ.entityFontFamily.groups.NAME,l.groupMapping={},l.groupMapping[SEQ.entityFontFamily.groups.FONT_FAMILY]={style:c.KEYWORD},l.groupMapping[SEQ.entityFontFamily.groups.NAME]={style:c.PARAMETER},l.progressStream=a,d.push(l);var m={};m.regExp=SEQ.entityFontSize.regExp,m.maxGroup=SEQ.entityFontSize.groups.SIZE,m.groupMapping={},m.groupMapping[SEQ.entityFontSize.groups.FONT_SIZE]={style:c.KEYWORD},m.groupMapping[SEQ.entityFontSize.groups.SIZE]={style:c.PARAMETER},m.progressStream=a,d.push(m);var n={};n.regExp=SEQ.entityLinear.regExp,n.maxGroup=SEQ.entityLinear.groups.STATUS,n.groupMapping={},n.groupMapping[SEQ.entityLinear.groups.LINEAR]={style:c.KEYWORD},n.groupMapping[SEQ.entityLinear.groups.STATUS]={style:c.PARAMETER},n.progressStream=a,d.push(n);var o={};o.regExp=SEQ.entityParallel.regExp,o.maxGroup=SEQ.entityParallel.groups.STATUS,o.groupMapping={},o.groupMapping[SEQ.entityParallel.groups.PARALLEL]={style:c.KEYWORD},o.groupMapping[SEQ.entityParallel.groups.STATUS]={style:c.PARAMETER},o.progressStream=a,d.push(o);var p={};p.regExp=SEQ.entityParticipant.regExp,p.maxGroup=SEQ.entityParticipant.groups.COLOR_NAME,p.groupMapping={},p.groupMapping[SEQ.entityParticipant.groups.TYPE]={style:c.KEYWORD},p.groupMapping[SEQ.entityParticipant.groups.ICON_FONT_TYPE]={style:c.KEYWORD},p.groupMapping[SEQ.entityParticipant.groups.ICON_UNICODE]={style:c.PARAMETER},p.groupMapping[SEQ.entityParticipant.groups.QUOTE_1]={style:c.KEYWORD},p.groupMapping[SEQ.entityParticipant.groups.LONG_NAME]={style:c.TEXT},p.groupMapping[SEQ.entityParticipant.groups.QUOTE_2]={style:c.KEYWORD},p.groupMapping[SEQ.entityParticipant.groups.AS]={style:c.KEYWORD},p.groupMapping[SEQ.entityParticipant.groups.ALIAS]={style:c.ACTOR},p.groupMapping[SEQ.entityParticipant.groups.COLOR_HEX]={style:c.PARAMETER},p.groupMapping[SEQ.entityParticipant.groups.COLOR_NAME]={style:c.PARAMETER},p.progressStream=a,d.push(p);var q={};q.regExp=SEQ.entityParticipantSpacing.regExp,q.maxGroup=SEQ.entityParticipantSpacing.groups.SPACING,q.groupMapping={},q.groupMapping[SEQ.entityParticipantSpacing.groups.PARTICIPANT_SPACING]={style:c.KEYWORD},q.groupMapping[SEQ.entityParticipantSpacing.groups.SPACING]={style:c.PARAMETER},q.progressStream=a,d.push(q);var r={};r.regExp=SEQ.entitySpace.regExp,r.maxGroup=SEQ.entitySpace.groups.VALUE,r.groupMapping={},r.groupMapping[SEQ.entitySpace.groups.SPACE]={style:c.KEYWORD},r.groupMapping[SEQ.entitySpace.groups.VALUE]={style:c.PARAMETER},r.progressStream=a,d.push(r);var s={};s.regExp=SEQ.entityTitle.regExp,s.maxGroup=SEQ.entityTitle.groups.VALUE,s.groupMapping={},s.groupMapping[SEQ.entityTitle.groups.TITLE]={style:c.KEYWORD},s.groupMapping[SEQ.entityTitle.groups.VALUE]={style:c.TEXT},s.progressStream=a,d.push(s);var t={};t.regExp=SEQ.parser.regExpComment,t.maxGroup=1,t.groupMapping={},t.groupMapping[1]={style:c.COMMENT},t.progressStream=a,d.push(t);var u={};u.regExp=SEQ.entityCreateDestroy.regExp,u.maxGroup=SEQ.entityCreateDestroy.groups.PARTICIPANT,u.groupMapping={},u.groupMapping[SEQ.entityCreateDestroy.groups.TYPE]={style:c.KEYWORD},u.groupMapping[SEQ.entityCreateDestroy.groups.PARTICIPANT]={style:c.ACTOR},u.progressStream=a,d.push(u);var v={};v.regExp=SEQ.entityActiveColor.regExp,v.maxGroup=SEQ.entityActiveColor.groups.COLOR_HEX,v.groupMapping={},v.groupMapping[SEQ.entityActiveColor.groups.ACTIVE_COLOR]={style:c.KEYWORD},v.groupMapping[SEQ.entityActiveColor.groups.PARTICIPANT]={style:c.ACTOR},v.groupMapping[SEQ.entityActiveColor.groups.COLOR_NAME]={style:c.PARAMETER},v.groupMapping[SEQ.entityActiveColor.groups.COLOR_HEX]={style:c.PARAMETER},v.progressStream=a,d.push(v);var w={};w.regExp=SEQ.entityLifeLineColor.regExp,w.maxGroup=SEQ.entityLifeLineColor.groups.COLOR_HEX,w.groupMapping={},w.groupMapping[SEQ.entityLifeLineColor.groups.LIFE_LINE_COLOR]={style:c.KEYWORD},w.groupMapping[SEQ.entityLifeLineColor.groups.PARTICIPANT]={style:c.ACTOR},w.groupMapping[SEQ.entityLifeLineColor.groups.COLOR_NAME]={style:c.PARAMETER},w.groupMapping[SEQ.entityLifeLineColor.groups.COLOR_HEX]={style:c.PARAMETER},w.progressStream=a,d.push(w);var x={};x.regExp=SEQ.entityLifeLineWeight.regExp,x.maxGroup=SEQ.entityLifeLineWeight.groups.VALUE,x.groupMapping={},x.groupMapping[SEQ.entityLifeLineWeight.groups.LIFE_LINE_WEIGHT]={style:c.KEYWORD},x.groupMapping[SEQ.entityLifeLineWeight.groups.VALUE]={style:c.PARAMETER},x.progressStream=a,d.push(x)}function b(a){if(!a.sol())return a.progressStream(a);for(var b=0;b<d.length;b++){var c=d[b],e=a.match(c.regExp,!1,!1);if(e)return a.match=e,a.currentGroup=0,a.maxGroup=c.maxGroup,a.groupMapping=c.groupMapping,a.progressStream=c.progressStream,a.progressStream(a)}a.skipToEnd()}var c={KEYWORD:"def",ACTOR:"tag",TEXT:"variable",COMMENT:"comment",ERROR:"error",ARROW:"keyword",PARAMETER:"bracket"},d=[];return{init:function(){a(),CodeMirror.defineMode("seqdiamode",function(){return{token:b}})}}}();